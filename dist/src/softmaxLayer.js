var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var Layer = require('./layer');
var Squash = require('./squash');
var _Utils = require('./utils');
var Utils = _Utils.Utils;
var SoftMaxLayer = (function (_super) {
    __extends(SoftMaxLayer, _super);
    function SoftMaxLayer(size, label) {
        _super.call(this, size, label);
        this.optimizable = false;
        for (var n = 0; n < this.list.length; n++) {
            this.list[n].squash = Squash.IDENTITY;
        }
    }
    SoftMaxLayer.prototype.activate = function (input) {
        if (this.currentActivation.length != this.list.length)
            this.currentActivation = new Float64Array(this.list.length);
        var activationIndex = 0;
        var sum = 0;
        var Amax = null;
        if (typeof input != 'undefined') {
            if (input.length != this.size)
                throw "INPUT size and LAYER size must be the same to activate!";
            Utils.softMax(input);
            for (var id in this.list) {
                this.list[id].readIncommingConnections(input[id]);
                if (Amax === null || this.list[id].activation > Amax)
                    Amax = this.list[id].activation;
            }
        }
        else {
            for (var id in this.list) {
                this.list[id].readIncommingConnections();
                if (Amax === null || this.list[id].activation > Amax)
                    Amax = this.list[id].activation;
            }
        }
        for (var n = 0; n < this.currentActivation.length; n++) {
            sum += (this.list[n].activation = Math.exp(this.list[n].activation - Amax));
        }
        for (var n = 0; n < this.currentActivation.length; n++) {
            // set the activations
            var x = this.list[n].activation / sum;
            this.list[n].activation = this.currentActivation[n] = x;
            // set the derivatives
            //x = this.list[n].activation / (sum - this.list[n].activation);
            this.list[n].derivative = x * (1 - x);
            this.list[n].updateTraces();
        }
        return this.currentActivation;
    };
    SoftMaxLayer.NormalizeConnectionWeights = function (layerConnection) {
        var sum = 0;
        for (var c = 0; c < layerConnection.list.length; c++) {
            sum += (layerConnection.list[c].weight = Math.exp(layerConnection.list[c].weight));
        }
        for (var c = 0; c < layerConnection.list.length; c++) {
            layerConnection.list[c].weight /= sum;
        }
    };
    return SoftMaxLayer;
})(Layer.Layer);
exports.SoftMaxLayer = SoftMaxLayer;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9zb2Z0bWF4TGF5ZXIudHMiXSwibmFtZXMiOlsiU29mdE1heExheWVyIiwiU29mdE1heExheWVyLmNvbnN0cnVjdG9yIiwiU29mdE1heExheWVyLmFjdGl2YXRlIiwiU29mdE1heExheWVyLk5vcm1hbGl6ZUNvbm5lY3Rpb25XZWlnaHRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQSxJQUFPLEtBQUssV0FBVyxTQUFTLENBQUMsQ0FBQztBQUNsQyxJQUFPLE1BQU0sV0FBVyxVQUFVLENBQUMsQ0FBQztBQUVwQyxJQUFPLE1BQU0sV0FBVyxTQUFTLENBQUMsQ0FBQztBQUNuQyxJQUFJLEtBQUssR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDO0FBRXpCLElBQWEsWUFBWTtJQUFTQSxVQUFyQkEsWUFBWUEsVUFBb0JBO0lBQzVDQSxTQURZQSxZQUFZQSxDQUNaQSxJQUFZQSxFQUFFQSxLQUFjQTtRQUN2Q0Msa0JBQU1BLElBQUlBLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO1FBRW5CQSxJQUFJQSxDQUFDQSxXQUFXQSxHQUFHQSxLQUFLQSxDQUFDQTtRQUV6QkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsRUFBRUEsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0E7WUFDM0NBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLE1BQU1BLEdBQUdBLE1BQU1BLENBQUNBLFFBQVFBLENBQUNBO1FBQ3ZDQSxDQUFDQTtJQUNGQSxDQUFDQTtJQUVERCwrQkFBUUEsR0FBUkEsVUFBU0EsS0FBOEJBO1FBQ3RDRSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBLE1BQU1BLElBQUlBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBO1lBQ3JEQSxJQUFJQSxDQUFDQSxpQkFBaUJBLEdBQUdBLElBQUlBLFlBQVlBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO1FBRTdEQSxJQUFJQSxlQUFlQSxHQUFHQSxDQUFDQSxDQUFDQTtRQUV4QkEsSUFBSUEsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDWkEsSUFBSUEsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFFaEJBLEVBQUVBLENBQUNBLENBQUNBLE9BQU9BLEtBQUtBLElBQUlBLFdBQVdBLENBQUNBLENBQUNBLENBQUNBO1lBQ2pDQSxFQUFFQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxNQUFNQSxJQUFJQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQTtnQkFDN0JBLE1BQU1BLHlEQUF5REEsQ0FBQ0E7WUFFakVBLEtBQUtBLENBQUNBLE9BQU9BLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1lBRXJCQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxJQUFJQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDMUJBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLHdCQUF3QkEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2xEQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxLQUFLQSxJQUFJQSxJQUFJQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxVQUFVQSxHQUFHQSxJQUFJQSxDQUFDQTtvQkFDcERBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLFVBQVVBLENBQUNBO1lBQ2xDQSxDQUFDQTtRQUNGQSxDQUFDQTtRQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNQQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxJQUFJQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDMUJBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLHdCQUF3QkEsRUFBRUEsQ0FBQ0E7Z0JBQ3pDQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxLQUFLQSxJQUFJQSxJQUFJQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxVQUFVQSxHQUFHQSxJQUFJQSxDQUFDQTtvQkFDcERBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLFVBQVVBLENBQUNBO1lBQ2xDQSxDQUFDQTtRQUNGQSxDQUFDQTtRQUVEQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO1lBQ3hEQSxHQUFHQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxVQUFVQSxHQUFHQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxVQUFVQSxHQUFHQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUM3RUEsQ0FBQ0E7UUFFREEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsaUJBQWlCQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQSxFQUFFQSxFQUFFQSxDQUFDQTtZQUN4REEsQUFDQUEsc0JBRHNCQTtnQkFDbEJBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLFVBQVVBLEdBQUdBLEdBQUdBLENBQUNBO1lBQ3RDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxVQUFVQSxHQUFHQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1lBRXhEQSxBQUlBQSxzQkFKc0JBO1lBRXRCQSxnRUFBZ0VBO1lBRWhFQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxVQUFVQSxHQUFHQSxDQUFDQSxHQUFDQSxDQUFDQSxDQUFDQSxHQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUVsQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsWUFBWUEsRUFBRUEsQ0FBQ0E7UUFDN0JBLENBQUNBO1FBRURBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0E7SUFDL0JBLENBQUNBO0lBRU1GLHVDQUEwQkEsR0FBakNBLFVBQWtDQSxlQUE0Q0E7UUFDN0VHLElBQUlBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBO1FBQ1pBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLGVBQWVBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO1lBQ3REQSxHQUFHQSxJQUFJQSxDQUFDQSxlQUFlQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxlQUFlQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNwRkEsQ0FBQ0E7UUFDREEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsZUFBZUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsRUFBRUEsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0E7WUFDdERBLGVBQWVBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLE1BQU1BLElBQUlBLEdBQUdBLENBQUNBO1FBQ3ZDQSxDQUFDQTtJQUNGQSxDQUFDQTtJQUNGSCxtQkFBQ0E7QUFBREEsQ0FyRUEsQUFxRUNBLEVBckVpQyxLQUFLLENBQUMsS0FBSyxFQXFFNUM7QUFyRVksb0JBQVksR0FBWixZQXFFWixDQUFBIiwiZmlsZSI6InNyYy9zb2Z0bWF4TGF5ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU3luYXB0aWMgPSByZXF1aXJlKCcuL3N5bmFwdGljJyk7XG5pbXBvcnQgTGF5ZXIgPSByZXF1aXJlKCcuL2xheWVyJyk7XG5pbXBvcnQgU3F1YXNoID0gcmVxdWlyZSgnLi9zcXVhc2gnKTtcbmltcG9ydCBOZXVyb24gPSByZXF1aXJlKCcuL25ldXJvbicpO1xuaW1wb3J0IF9VdGlscyA9IHJlcXVpcmUoJy4vdXRpbHMnKTtcbnZhciBVdGlscyA9IF9VdGlscy5VdGlscztcblxuZXhwb3J0IGNsYXNzIFNvZnRNYXhMYXllciBleHRlbmRzIExheWVyLkxheWVyIHtcblx0Y29uc3RydWN0b3Ioc2l6ZTogbnVtYmVyLCBsYWJlbD86IHN0cmluZykge1xuXHRcdHN1cGVyKHNpemUsIGxhYmVsKTtcblxuXHRcdHRoaXMub3B0aW1pemFibGUgPSBmYWxzZTtcblxuXHRcdGZvciAodmFyIG4gPSAwOyBuIDwgdGhpcy5saXN0Lmxlbmd0aDsgbisrKSB7XG5cdFx0XHR0aGlzLmxpc3Rbbl0uc3F1YXNoID0gU3F1YXNoLklERU5USVRZO1xuXHRcdH1cblx0fVxuXG5cdGFjdGl2YXRlKGlucHV0PzogU3luYXB0aWMuSU51bWVyaWNBcnJheSk6IFN5bmFwdGljLklOdW1lcmljQXJyYXkge1xuXHRcdGlmICh0aGlzLmN1cnJlbnRBY3RpdmF0aW9uLmxlbmd0aCAhPSB0aGlzLmxpc3QubGVuZ3RoKVxuXHRcdFx0dGhpcy5jdXJyZW50QWN0aXZhdGlvbiA9IG5ldyBGbG9hdDY0QXJyYXkodGhpcy5saXN0Lmxlbmd0aCk7XG5cblx0XHR2YXIgYWN0aXZhdGlvbkluZGV4ID0gMDtcblxuXHRcdHZhciBzdW0gPSAwO1xuXHRcdHZhciBBbWF4ID0gbnVsbDtcblx0XHRcblx0XHRpZiAodHlwZW9mIGlucHV0ICE9ICd1bmRlZmluZWQnKSB7XG5cdFx0XHRpZiAoaW5wdXQubGVuZ3RoICE9IHRoaXMuc2l6ZSlcblx0XHRcdFx0dGhyb3cgXCJJTlBVVCBzaXplIGFuZCBMQVlFUiBzaXplIG11c3QgYmUgdGhlIHNhbWUgdG8gYWN0aXZhdGUhXCI7XG5cblx0XHRcdFV0aWxzLnNvZnRNYXgoaW5wdXQpO1xuXG5cdFx0XHRmb3IgKHZhciBpZCBpbiB0aGlzLmxpc3QpIHtcblx0XHRcdFx0dGhpcy5saXN0W2lkXS5yZWFkSW5jb21taW5nQ29ubmVjdGlvbnMoaW5wdXRbaWRdKTtcblx0XHRcdFx0aWYgKEFtYXggPT09IG51bGwgfHwgdGhpcy5saXN0W2lkXS5hY3RpdmF0aW9uID4gQW1heClcblx0XHRcdFx0XHRBbWF4ID0gdGhpcy5saXN0W2lkXS5hY3RpdmF0aW9uO1xuXHRcdFx0fVxuXHRcdH0gZWxzZSB7XG5cdFx0XHRmb3IgKHZhciBpZCBpbiB0aGlzLmxpc3QpIHtcblx0XHRcdFx0dGhpcy5saXN0W2lkXS5yZWFkSW5jb21taW5nQ29ubmVjdGlvbnMoKTtcblx0XHRcdFx0aWYgKEFtYXggPT09IG51bGwgfHwgdGhpcy5saXN0W2lkXS5hY3RpdmF0aW9uID4gQW1heClcblx0XHRcdFx0XHRBbWF4ID0gdGhpcy5saXN0W2lkXS5hY3RpdmF0aW9uO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGZvciAodmFyIG4gPSAwOyBuIDwgdGhpcy5jdXJyZW50QWN0aXZhdGlvbi5sZW5ndGg7IG4rKykge1xuXHRcdFx0c3VtICs9ICh0aGlzLmxpc3Rbbl0uYWN0aXZhdGlvbiA9IE1hdGguZXhwKHRoaXMubGlzdFtuXS5hY3RpdmF0aW9uIC0gQW1heCkpO1xuXHRcdH1cblx0XHRcblx0XHRmb3IgKHZhciBuID0gMDsgbiA8IHRoaXMuY3VycmVudEFjdGl2YXRpb24ubGVuZ3RoOyBuKyspIHtcblx0XHRcdC8vIHNldCB0aGUgYWN0aXZhdGlvbnNcblx0XHRcdHZhciB4ID0gdGhpcy5saXN0W25dLmFjdGl2YXRpb24gLyBzdW07XG5cdFx0XHR0aGlzLmxpc3Rbbl0uYWN0aXZhdGlvbiA9IHRoaXMuY3VycmVudEFjdGl2YXRpb25bbl0gPSB4O1xuXHRcdFx0XG5cdFx0XHQvLyBzZXQgdGhlIGRlcml2YXRpdmVzXG5cdFx0XHRcblx0XHRcdC8veCA9IHRoaXMubGlzdFtuXS5hY3RpdmF0aW9uIC8gKHN1bSAtIHRoaXMubGlzdFtuXS5hY3RpdmF0aW9uKTtcblx0XHRcdFxuXHRcdFx0dGhpcy5saXN0W25dLmRlcml2YXRpdmUgPSB4KigxLXgpO1xuXHRcdFx0XG5cdFx0XHR0aGlzLmxpc3Rbbl0udXBkYXRlVHJhY2VzKCk7XG5cdFx0fVxuXHRcdFxuXHRcdHJldHVybiB0aGlzLmN1cnJlbnRBY3RpdmF0aW9uO1xuXHR9XG5cblx0c3RhdGljIE5vcm1hbGl6ZUNvbm5lY3Rpb25XZWlnaHRzKGxheWVyQ29ubmVjdGlvbjogTGF5ZXIuTGF5ZXIuTGF5ZXJDb25uZWN0aW9uKSB7XG5cdFx0dmFyIHN1bSA9IDA7XG5cdFx0Zm9yICh2YXIgYyA9IDA7IGMgPCBsYXllckNvbm5lY3Rpb24ubGlzdC5sZW5ndGg7IGMrKykge1xuXHRcdFx0c3VtICs9IChsYXllckNvbm5lY3Rpb24ubGlzdFtjXS53ZWlnaHQgPSBNYXRoLmV4cChsYXllckNvbm5lY3Rpb24ubGlzdFtjXS53ZWlnaHQpKTtcblx0XHR9XG5cdFx0Zm9yICh2YXIgYyA9IDA7IGMgPCBsYXllckNvbm5lY3Rpb24ubGlzdC5sZW5ndGg7IGMrKykge1xuXHRcdFx0bGF5ZXJDb25uZWN0aW9uLmxpc3RbY10ud2VpZ2h0IC89IHN1bTtcblx0XHR9XG5cdH1cbn0iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=