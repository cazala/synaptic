/*!
 * The MIT License (MIT)
 * 
 * Copyright (c) 2017 Juan Cazala - juancazala.com
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE
 * 
 * 
 * 
 * ********************************************************************************************
 *                                   SYNAPTIC (v1.0.12)
 * ********************************************************************************************
 * 
 * Synaptic is a javascript neural network library for node.js and the browser, its generalized
 * algorithm is architecture-free, so you can build and train basically any type of first order
 * or even second order neural network architectures.
 * 
 * http://en.wikipedia.org/wiki/Recurrent_neural_network#Second_Order_Recurrent_Neural_Network
 * 
 * The library includes a few built-in architectures like multilayer perceptrons, multilayer
 * long-short term memory networks (LSTM) or liquid state machines, and a trainer capable of
 * training any given network, and includes built-in training tasks/tests like solving an XOR,
 * passing a Distracted Sequence Recall test or an Embeded Reber Grammar test.
 * 
 * The algorithm implemented by this library has been taken from Derek D. Monner's paper:
 * 
 * 
 * A generalized LSTM-like training algorithm for second-order recurrent neural networks
 * http://www.overcomplete.net/papers/nn2012.pdf
 * 
 * There are references to the equations in that paper commented through the source code.
 * 
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.synaptic=e():t.synaptic=e()}(this,function(){return function(t){function e(i){if(n[i])return n[i].exports;var r=n[i]={exports:{},id:i,loaded:!1};return t[i].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){var i,r,o={Neuron:n(1),Layer:n(3),Network:n(4),Trainer:n(5),Architect:n(6)};i=[],r=function(){return o}.apply(e,i),!(void 0!==r&&(t.exports=r)),"undefined"!=typeof t&&t.exports&&(t.exports=o),"object"==typeof window&&(!function(){var t=window.synaptic;o.ninja=function(){return window.synaptic=t,o}}(),window.synaptic=o)},function(t,e,n){(function(t){function e(){this.ID=e.uid(),this.connections={inputs:{},projected:{},gated:{}},this.error={responsibility:0,projected:0,gated:0},this.trace={elegibility:{},extended:{},influences:{}},this.state=0,this.old=0,this.activation=0,this.selfconnection=new e.connection(this,this,0),this.squash=e.squash.LOGISTIC,this.neighboors={},this.bias=.2*Math.random()-.1}t&&(t.exports=e),e.prototype={activate:function(t){if("undefined"!=typeof t)return this.activation=t,this.derivative=0,this.bias=0,this.activation;this.old=this.state,this.state=this.selfconnection.gain*this.selfconnection.weight*this.state+this.bias;for(var e in this.connections.inputs){var t=this.connections.inputs[e];this.state+=t.from.activation*t.weight*t.gain}this.activation=this.squash(this.state),this.derivative=this.squash(this.state,!0);var n=[];for(var i in this.trace.extended){var r=this.neighboors[i],o=r.selfconnection.gater==this?r.old:0;for(var s in this.trace.influences[r.ID])o+=this.trace.influences[r.ID][s].weight*this.trace.influences[r.ID][s].from.activation;n[r.ID]=o}for(var e in this.connections.inputs){var t=this.connections.inputs[e];this.trace.elegibility[t.ID]=this.selfconnection.gain*this.selfconnection.weight*this.trace.elegibility[t.ID]+t.gain*t.from.activation;for(var i in this.trace.extended){var a=this.trace.extended[i],r=this.neighboors[i],o=n[r.ID];a[t.ID]=r.selfconnection.gain*r.selfconnection.weight*a[t.ID]+this.derivative*this.trace.elegibility[t.ID]*o}}for(var c in this.connections.gated)this.connections.gated[c].gain=this.activation;return this.activation},propagate:function(t,e){var n=0,i="undefined"!=typeof e;if(i)this.error.responsibility=this.error.projected=e-this.activation;else{for(var r in this.connections.projected){var o=this.connections.projected[r],s=o.to;n+=s.error.responsibility*o.gain*o.weight}this.error.projected=this.derivative*n,n=0;for(var r in this.trace.extended){var s=this.neighboors[r],a=s.selfconnection.gater==this?s.old:0;for(var c in this.trace.influences[r])a+=this.trace.influences[r][c].weight*this.trace.influences[s.ID][c].from.activation;n+=s.error.responsibility*a}this.error.gated=this.derivative*n,this.error.responsibility=this.error.projected+this.error.gated}t=t||.1;for(var r in this.connections.inputs){var c=this.connections.inputs[r],h=this.error.projected*this.trace.elegibility[c.ID];for(var r in this.trace.extended){var s=this.neighboors[r];h+=s.error.responsibility*this.trace.extended[s.ID][c.ID]}c.weight+=t*h}this.bias+=t*this.error.responsibility},project:function(t,n){if(t==this)return this.selfconnection.weight=1,this.selfconnection;var i=this.connected(t);if(i&&"projected"==i.type)return"undefined"!=typeof n&&(i.connection.weight=n),i.connection;var r=new e.connection(this,t,n);this.connections.projected[r.ID]=r,this.neighboors[t.ID]=t,t.connections.inputs[r.ID]=r,t.trace.elegibility[r.ID]=0;for(var o in t.trace.extended){var s=t.trace.extended[o];s[r.ID]=0}return r},gate:function(t){this.connections.gated[t.ID]=t;var e=t.to;if(!(e.ID in this.trace.extended)){this.neighboors[e.ID]=e;var n=this.trace.extended[e.ID]={};for(var i in this.connections.inputs){var r=this.connections.inputs[i];n[r.ID]=0}}e.ID in this.trace.influences?this.trace.influences[e.ID].push(t):this.trace.influences[e.ID]=[t],t.gater=this},selfconnected:function(){return 0!==this.selfconnection.weight},connected:function(t){var e={type:null,connection:!1};if(this==t)return!!this.selfconnected()&&(e.type="selfconnection",e.connection=this.selfconnection,e);for(var n in this.connections)for(var i in this.connections[n]){var i=this.connections[n][i];if(i.to==t)return e.type=n,e.connection=i,e;if(i.from==t)return e.type=n,e.connection=i,e}return!1},clear:function(){for(var t in this.trace.elegibility)this.trace.elegibility[t]=0;for(var t in this.trace.extended)for(var e in this.trace.extended[t])this.trace.extended[t][e]=0;this.error.responsibility=this.error.projected=this.error.gated=0},reset:function(){this.clear();for(var t in this.connections)for(var e in this.connections[t])this.connections[t][e].weight=.2*Math.random()-.1;this.bias=.2*Math.random()-.1,this.old=this.state=this.activation=0},optimize:function(t,n){t=t||{};var i=[],r=[],o=[],s=t.memory||0,a=t.neurons||1,c=t.inputs||[],h=t.targets||[],u=t.outputs||[],p=t.variables||{},l=t.activation_sentences||[],f=t.trace_sentences||[],d=t.propagation_sentences||[],v=t.layers||{__count:0,__neuron:0},g=function(t){var e=n in v&&t[v.__count];e||(v.__count=t.push([])-1,v[n]=v.__count)};g(l),g(f),g(d);var y=v.__count,m=function(){var t=Array.prototype.slice.call(arguments);if(1==t.length){if("target"==t[0]){var e="target_"+h.length;h.push(s)}else var e=t[0];return e in p?p[e]:p[e]={value:0,id:s++}}var n=t.length>2;if(n)var i=t.pop();var r=t.shift(),o=t.pop();if(!n)var i=r[o];for(var e=o+"_",a=0;a<t.length;a++)e+=t[a]+"_";return e+=r.ID,e in p?p[e]:p[e]={value:i,id:s++}},w=function(){for(var t=Array.prototype.slice.call(arguments),e=t.pop(),n="",i=0;i<t.length;i++)n+="string"==typeof t[i]?t[i]:"F["+t[i].id+"]";e.push(n+";")},T=function(t){for(var e in t)if(t.hasOwnProperty(e))return!1;return!0},b=T(this.connections.projected),I=T(this.connections.gated),D="input"==n||T(this.connections.inputs),_="output"==n||b&&I,O=m("rate"),E=m(this,"activation");if(D)c.push(E.id);else{l[y].push(i),f[y].push(r),d[y].push(o);var z=m(this,"old"),j=m(this,"state"),L=m(this,"bias");if(this.selfconnection.gater)var S=m(this.selfconnection,"gain");if(this.selfconnected())var x=m(this.selfconnection,"weight");w(z," = ",j,i),this.selfconnected()?this.selfconnection.gater?w(j," = ",S," * ",x," * ",j," + ",L,i):w(j," = ",x," * ",j," + ",L,i):w(j," = ",L,i);for(var N in this.connections.inputs){var A=this.connections.inputs[N],M=m(A.from,"activation"),k=m(A,"weight");if(A.gater)var R=m(A,"gain");this.connections.inputs[N].gater?w(j," += ",M," * ",k," * ",R,i):w(j," += ",M," * ",k,i)}var q=m(this,"derivative");switch(this.squash){case e.squash.LOGISTIC:w(E," = (1 / (1 + Math.exp(-",j,")))",i),w(q," = ",E," * (1 - ",E,")",i);break;case e.squash.TANH:var F=m("aux"),P=m("aux_2");w(F," = Math.exp(",j,")",i),w(P," = 1 / ",F,i),w(E," = (",F," - ",P,") / (",F," + ",P,")",i),w(q," = 1 - (",E," * ",E,")",i);break;case e.squash.IDENTITY:w(E," = ",j,i),w(q," = 1",i);break;case e.squash.HLIM:w(E," = +(",j," > 0)",i),w(q," = 1",i);case e.squash.RELU:w(E," = ",j," > 0 ? ",j," : 0",i),w(q," = ",j," > 0 ? 1 : 0",i)}for(var U in this.trace.extended){var H=this.neighboors[U],V=m("influences["+H.ID+"]"),C=m(H,"old"),G=!1;H.selfconnection.gater==this&&(w(V," = ",C,r),G=!0);for(var Y in this.trace.influences[H.ID]){var B=m(this.trace.influences[H.ID][Y],"weight"),W=m(this.trace.influences[H.ID][Y].from,"activation");G?w(V," += ",B," * ",W,r):(w(V," = ",B," * ",W,r),G=!0)}}for(var N in this.connections.inputs){var A=this.connections.inputs[N];if(A.gater)var R=m(A,"gain");var M=m(A.from,"activation"),J=m(this,"trace","elegibility",A.ID,this.trace.elegibility[A.ID]);this.selfconnected()?this.selfconnection.gater?A.gater?w(J," = ",S," * ",x," * ",J," + ",R," * ",M,r):w(J," = ",S," * ",x," * ",J," + ",M,r):A.gater?w(J," = ",x," * ",J," + ",R," * ",M,r):w(J," = ",x," * ",J," + ",M,r):A.gater?w(J," = ",R," * ",M,r):w(J," = ",M,r);for(var U in this.trace.extended){var H=this.neighboors[U],V=m("influences["+H.ID+"]"),J=m(this,"trace","elegibility",A.ID,this.trace.elegibility[A.ID]),K=m(this,"trace","extended",H.ID,A.ID,this.trace.extended[H.ID][A.ID]);if(H.selfconnected())var X=m(H.selfconnection,"weight");if(H.selfconnection.gater)var Q=m(H.selfconnection,"gain");H.selfconnected()?H.selfconnection.gater?w(K," = ",Q," * ",X," * ",K," + ",q," * ",J," * ",V,r):w(K," = ",X," * ",K," + ",q," * ",J," * ",V,r):w(K," = ",q," * ",J," * ",V,r)}}for(var Z in this.connections.gated){var $=m(this.connections.gated[Z],"gain");w($," = ",E,i)}}if(!D){var tt=m(this,"error","responsibility",this.error.responsibility);if(_){var et=m("target");w(tt," = ",et," - ",E,o);for(var U in this.connections.inputs){var A=this.connections.inputs[U],J=m(this,"trace","elegibility",A.ID,this.trace.elegibility[A.ID]),k=m(A,"weight");w(k," += ",O," * (",tt," * ",J,")",o)}u.push(E.id)}else if(b||I){if(I){w(tt," = 0",o);for(var U in this.connections.projected){var Z=this.connections.projected[U],H=Z.to,nt=m(Z,"weight"),it=m(H,"error","responsibility",H.error.responsibility);if(Z.gater){var rt=m(Z,"gain");w(tt," += ",it," * ",rt," * ",nt,o)}else w(tt," += ",it," * ",nt,o)}w(tt," *= ",q,o);for(var U in this.connections.inputs){var A=this.connections.inputs[U],J=m(this,"trace","elegibility",A.ID,this.trace.elegibility[A.ID]),k=m(A,"weight");w(k," += ",O," * (",tt," * ",J,")",o)}}else if(b){w(tt," = 0",o);for(var U in this.trace.extended){var H=this.neighboors[U],V=m("aux"),C=m(H,"old");H.selfconnection.gater==this?w(V," = ",C,o):w(V," = 0",o);for(var A in this.trace.influences[H.ID]){var Z=this.trace.influences[H.ID][A],nt=m(Z,"weight"),ot=m(Z.from,"activation");w(V," += ",nt," * ",ot,o)}var it=m(H,"error","responsibility",H.error.responsibility);w(tt," += ",it," * ",V,o)}w(tt," *= ",q,o);for(var U in this.connections.inputs){var A=this.connections.inputs[U],st=m("aux");w(st," = 0",o);for(var U in this.trace.extended){var H=this.neighboors[U],it=m(H,"error","responsibility",H.error.responsibility),K=m(this,"trace","extended",H.ID,A.ID,this.trace.extended[H.ID][A.ID]);w(st," += ",it," * ",K,o)}var k=m(A,"weight");w(k," += ",O," * ",st,o)}}}else{var at=m("aux");for(var U in this.connections.projected){var Z=this.connections.projected[U],H=Z.to,nt=m(Z,"weight"),it=m(H,"error","responsibility",H.error.responsibility);if(Z.gater){var rt=m(Z,"gain");w(at," += ",it," * ",rt," * ",nt,o)}else w(at," += ",it," * ",nt,o)}var ct=m(this,"error","projected",this.error.projected);w(ct," = ",q," * ",at,o),w(at," = 0",o);for(var U in this.trace.extended){var H=this.neighboors[U],V=m("aux_2"),C=m(H,"old");H.selfconnection.gater==this?w(V," = ",C,o):w(V," = 0",o);for(var A in this.trace.influences[H.ID]){var Z=this.trace.influences[H.ID][A],nt=m(Z,"weight"),ot=m(Z.from,"activation");w(V," += ",nt," * ",ot,o)}var it=m(H,"error","responsibility",H.error.responsibility);w(at," += ",it," * ",V,o)}var ht=m(this,"error","gated",this.error.gated);w(ht," = ",q," * ",at,o),w(tt," = ",ct," + ",ht,o);for(var U in this.connections.inputs){var A=this.connections.inputs[U],st=m("aux"),J=m(this,"trace","elegibility",A.ID,this.trace.elegibility[A.ID]);w(st," = ",ct," * ",J,o);for(var U in this.trace.extended){var H=this.neighboors[U],it=m(H,"error","responsibility",H.error.responsibility),K=m(this,"trace","extended",H.ID,A.ID,this.trace.extended[H.ID][A.ID]);w(st," += ",it," * ",K,o)}var k=m(A,"weight");w(k," += ",O," * ",st,o)}}w(L," += ",O," * ",tt,o)}return{memory:s,neurons:a+1,inputs:c,outputs:u,targets:h,variables:p,activation_sentences:l,trace_sentences:f,propagation_sentences:d,layers:v}}},e.connection=function(t,n,i){if(!t||!n)throw new Error("Connection Error: Invalid neurons");this.ID=e.connection.uid(),this.from=t,this.to=n,this.weight="undefined"==typeof i?.2*Math.random()-.1:i,this.gain=1,this.gater=null},e.squash={},e.squash.LOGISTIC=function(t,e){var n=1/(1+Math.exp(-t));return e?n*(1-n):n},e.squash.TANH=function(t,e){return e?1-Math.pow(Math.tanh(t),2):Math.tanh(t)},e.squash.IDENTITY=function(t,e){return e?1:t},e.squash.HLIM=function(t,e){return e?1:t>0?1:0},e.squash.RELU=function(t,e){return e?t>0?1:0:t>0?t:0},function(){var t=0,n=0;e.uid=function(){return t++},e.connection.uid=function(){return n++},e.quantity=function(){return{neurons:t,connections:n}}}()}).call(e,n(2)(t))},function(t,e){t.exports=function(t){return t.webpackPolyfill||(t.deprecate=function(){},t.paths=[],t.children=[],t.webpackPolyfill=1),t}},function(t,e,n){(function(t){function e(t){for(this.size=0|t,this.list=[],this.connectedTo=[];t--;){var e=new i;this.list.push(e)}}t&&(t.exports=e);var i=n(1),r=n(4);e.prototype={activate:function(t){var e=[];if("undefined"!=typeof t){if(t.length!=this.size)throw new Error("INPUT size and LAYER size must be the same to activate!");for(var n in this.list){var i=this.list[n],r=i.activate(t[n]);e.push(r)}}else for(var n in this.list){var i=this.list[n],r=i.activate();e.push(r)}return e},propagate:function(t,e){if("undefined"!=typeof e){if(e.length!=this.size)throw new Error("TARGET size and LAYER size must be the same to propagate!");for(var n=this.list.length-1;n>=0;n--){var i=this.list[n];i.propagate(t,e[n])}}else for(var n=this.list.length-1;n>=0;n--){var i=this.list[n];i.propagate(t)}},project:function(t,n,i){if(t instanceof r&&(t=t.layers.input),!(t instanceof e))throw new Error("Invalid argument, you can only project connections to LAYERS and NETWORKS!");if(!this.connected(t))return new e.connection(this,t,n,i)},gate:function(t,n){if(n==e.gateType.INPUT){if(t.to.size!=this.size)throw new Error("GATER layer and CONNECTION.TO layer must be the same size in order to gate!");for(var i in t.to.list){var r=t.to.list[i],o=this.list[i];for(var s in r.connections.inputs){var a=r.connections.inputs[s];a.ID in t.connections&&o.gate(a)}}}else if(n==e.gateType.OUTPUT){if(t.from.size!=this.size)throw new Error("GATER layer and CONNECTION.FROM layer must be the same size in order to gate!");for(var i in t.from.list){var r=t.from.list[i],o=this.list[i];for(var c in r.connections.projected){var a=r.connections.projected[c];a.ID in t.connections&&o.gate(a)}}}else if(n==e.gateType.ONE_TO_ONE){if(t.size!=this.size)throw new Error("The number of GATER UNITS must be the same as the number of CONNECTIONS to gate!");for(var i in t.list){var o=this.list[i],a=t.list[i];o.gate(a)}}t.gatedfrom.push({layer:this,type:n})},selfconnected:function(){for(var t in this.list){var e=this.list[t];if(!e.selfconnected())return!1}return!0},connected:function(t){var n=0;for(var i in this.list)for(var r in t.list){var o=this.list[i],s=t.list[r],a=o.connected(s);"projected"==a.type&&n++}if(n==this.size*t.size)return e.connectionType.ALL_TO_ALL;n=0;for(var c in this.list){var o=this.list[c],s=t.list[c],a=o.connected(s);"projected"==a.type&&n++}return n==this.size?e.connectionType.ONE_TO_ONE:void 0},clear:function(){for(var t in this.list){var e=this.list[t];e.clear()}},reset:function(){for(var t in this.list){var e=this.list[t];e.reset()}},neurons:function(){return this.list},add:function(t){this.neurons[t.ID]=t||new i,this.list.push(t),this.size++},set:function(t){t=t||{};for(var e in this.list){var n=this.list[e];t.label&&(n.label=t.label+"_"+n.ID),t.squash&&(n.squash=t.squash),t.bias&&(n.bias=t.bias)}return this}},e.connection=function(t,n,i,r){if(this.ID=e.connection.uid(),this.from=t,this.to=n,this.selfconnection=n==t,this.type=i,this.connections={},this.list=[],this.size=0,this.gatedfrom=[],"undefined"==typeof this.type&&(t==n?this.type=e.connectionType.ONE_TO_ONE:this.type=e.connectionType.ALL_TO_ALL),this.type==e.connectionType.ALL_TO_ALL||this.type==e.connectionType.ALL_TO_ELSE)for(var o in this.from.list)for(var s in this.to.list){var a=this.from.list[o],c=this.to.list[s];if(this.type!=e.connectionType.ALL_TO_ELSE||a!=c){var h=a.project(c,r);this.connections[h.ID]=h,this.size=this.list.push(h)}}else if(this.type==e.connectionType.ONE_TO_ONE)for(var u in this.from.list){var a=this.from.list[u],c=this.to.list[u],h=a.project(c,r);this.connections[h.ID]=h,this.size=this.list.push(h)}t.connectedTo.push(this)},e.connectionType={},e.connectionType.ALL_TO_ALL="ALL TO ALL",e.connectionType.ONE_TO_ONE="ONE TO ONE",e.connectionType.ALL_TO_ELSE="ALL TO ELSE",e.gateType={},e.gateType.INPUT="INPUT",e.gateType.OUTPUT="OUTPUT",e.gateType.ONE_TO_ONE="ONE TO ONE",function(){var t=0;e.connection.uid=function(){return t++}}()}).call(e,n(2)(t))},function(t,e,n){(function(t){function e(t){"undefined"!=typeof t&&(this.layers={input:t.input||null,hidden:t.hidden||[],output:t.output||null},this.optimized=null)}t&&(t.exports=e);var i=n(1),r=n(3),o=n(5);e.prototype={activate:function(t){if(this.optimized===!1){this.layers.input.activate(t);for(var e=0;e<this.layers.hidden.length;e++)this.layers.hidden[e].activate();return this.layers.output.activate()}return null==this.optimized&&this.optimize(),this.optimized.activate(t)},propagate:function(t,e){if(this.optimized===!1){this.layers.output.propagate(t,e);for(var n=this.layers.hidden.length-1;n>=0;n--)this.layers.hidden[n].propagate(t)}else null==this.optimized&&this.optimize(),this.optimized.propagate(t,e)},project:function(t,n,i){if(this.optimized&&this.optimized.reset(),t instanceof e)return this.layers.output.project(t.layers.input,n,i);if(t instanceof r)return this.layers.output.project(t,n,i);throw new Error("Invalid argument, you can only project connections to LAYERS and NETWORKS!")},gate:function(t,e){this.optimized&&this.optimized.reset(),this.layers.output.gate(t,e)},clear:function(){this.restore();var t=this.layers.input,e=this.layers.output;t.clear();for(var n=0;n<this.layers.hidden.length;n++)this.layers.hidden[n].clear();e.clear(),this.optimized&&this.optimized.reset()},reset:function(){this.restore();var t=this.layers.input,e=this.layers.output;t.reset();for(var n=0;n<this.layers.hidden.length;n++)this.layers.hidden[n].reset();e.reset(),this.optimized&&this.optimized.reset()},optimize:function(){for(var t=this,e={},n=this.neurons(),i=0;i<n.length;i++){for(var r=n[i].neuron,o=n[i].layer;r.neuron;)r=r.neuron;e=r.optimize(e,o)}for(var i=0;i<e.propagation_sentences.length;i++)e.propagation_sentences[i].reverse();e.propagation_sentences.reverse();var s="";s+="var F = Float64Array ? new Float64Array("+e.memory+") : []; ";for(var i in e.variables)s+="F["+e.variables[i].id+"] = "+(e.variables[i].value||0)+"; ";s+="var activate = function(input){\n";for(var i=0;i<e.inputs.length;i++)s+="F["+e.inputs[i]+"] = input["+i+"]; ";for(var i=0;i<e.activation_sentences.length;i++)if(e.activation_sentences[i].length>0)for(var a=0;a<e.activation_sentences[i].length;a++)s+=e.activation_sentences[i][a].join(" "),s+=e.trace_sentences[i][a].join(" ");s+=" var output = []; ";for(var i=0;i<e.outputs.length;i++)s+="output["+i+"] = F["+e.outputs[i]+"]; ";s+="return output; }; ",s+="var propagate = function(rate, target){\n",s+="F["+e.variables.rate.id+"] = rate; ";for(var i=0;i<e.targets.length;i++)s+="F["+e.targets[i]+"] = target["+i+"]; ";for(var i=0;i<e.propagation_sentences.length;i++)for(var a=0;a<e.propagation_sentences[i].length;a++)s+=e.propagation_sentences[i][a].join(" ")+" ";s+=" };\n",s+="var ownership = function(memoryBuffer){\nF = memoryBuffer;\nthis.memory = F;\n};\n",s+="return {\nmemory: F,\nactivate: activate,\npropagate: propagate,\nownership: ownership\n};",s=s.split(";").join(";\n");var c=new Function(s),h=c();h.data={variables:e.variables,activate:e.activation_sentences,propagate:e.propagation_sentences,trace:e.trace_sentences,inputs:e.inputs,outputs:e.outputs,check_activation:this.activate,check_propagation:this.propagate},h.reset=function(){t.optimized&&(t.optimized=null,t.activate=h.data.check_activation,t.propagate=h.data.check_propagation)},this.optimized=h,this.activate=h.activate,this.propagate=h.propagate},restore:function(){if(this.optimized)for(var t=this.optimized,e=(function(){var e=Array.prototype.slice.call(arguments),n=e.shift(),i=e.pop(),r=i+"_";for(var o in e)r+=e[o]+"_";r+=n.ID;var s=t.memory,a=t.data.variables;return r in a?s[a[r].id]:0}),n=this.neurons(),i=0;i<n.length;i++){for(var r=n[i].neuron;r.neuron;)r=r.neuron;r.state=e(r,"state"),r.old=e(r,"old"),r.activation=e(r,"activation"),r.bias=e(r,"bias");for(var o in r.trace.elegibility)r.trace.elegibility[o]=e(r,"trace","elegibility",o);for(var s in r.trace.extended)for(var o in r.trace.extended[s])r.trace.extended[s][o]=e(r,"trace","extended",s,o);for(var a in r.connections.projected){var c=r.connections.projected[a];c.weight=e(c,"weight"),c.gain=e(c,"gain")}}},neurons:function(){for(var t=[],e=this.layers.input.neurons(),n=this.layers.output.neurons(),i=0;i<e.length;i++)t.push({neuron:e[i],layer:"input"});for(var i=0;i<this.layers.hidden.length;i++)for(var r=this.layers.hidden[i].neurons(),o=0;o<r.length;o++)t.push({neuron:r[o],layer:i});for(var i=0;i<n.length;i++)t.push({neuron:n[i],layer:"output"});return t},inputs:function(){return this.layers.input.size},outputs:function(){return this.layers.output.size},set:function(t){this.layers={input:t.input||null,hidden:t.hidden||[],output:t.output||null},this.optimized&&this.optimized.reset()},setOptimize:function(t){this.restore(),this.optimized&&this.optimized.reset(),this.optimized=!!t&&null},toJSON:function(t){this.restore();for(var e=this.neurons(),n=[],r=[],o={},s=0;s<e.length;s++){for(var a=e[s].neuron;a.neuron;)a=a.neuron;o[a.ID]=s;var c={trace:{elegibility:{},extended:{}},state:a.state,old:a.old,activation:a.activation,bias:a.bias,layer:e[s].layer};c.squash=a.squash==i.squash.LOGISTIC?"LOGISTIC":a.squash==i.squash.TANH?"TANH":a.squash==i.squash.IDENTITY?"IDENTITY":a.squash==i.squash.HLIM?"HLIM":a.squash==i.squash.RELU?"RELU":null,n.push(c)}for(var s=0;s<e.length;s++){for(var a=e[s].neuron;a.neuron;)a=a.neuron;for(var h in a.connections.projected){var u=a.connections.projected[h];r.push({from:o[u.from.ID],to:o[u.to.ID],weight:u.weight,gater:u.gater?o[u.gater.ID]:null})}a.selfconnected()&&r.push({from:o[a.ID],to:o[a.ID],weight:a.selfconnection.weight,gater:a.selfconnection.gater?o[a.selfconnection.gater.ID]:null})}return{neurons:n,connections:r}},toDot:function(t){for(var e="digraph nn {\n    rankdir = BT\n",n=[this.layers.input].concat(this.layers.hidden,this.layers.output),i=0;i<n.length;i++)for(var r=0;r<n[i].connectedTo.length;r++){var o=n[i].connectedTo[r],s=o.to,a=o.size,c=n.indexOf(n[i]),h=n.indexOf(s);if(t){if(o.gatedfrom.length){var u="fake"+c+"_"+h;e+="    "+u+' [label = "", shape = point, width = 0.01, height = 0.01]\n',e+="    "+c+" -> "+u+" [label = "+a+", arrowhead = none]\n",e+="    "+u+" -> "+h+"\n"}else e+="    "+c+" -> "+h+" [label = "+a+"]\n";for(var p in o.gatedfrom){var l=o.gatedfrom[p].layer,f=n.indexOf(l);e+="    "+f+" -> "+u+" [color = blue]\n"}}else{e+="    "+c+" -> "+h+" [label = "+a+"]\n";for(var p in o.gatedfrom){var l=o.gatedfrom[p].layer,f=n.indexOf(l);e+="    "+f+" -> "+h+" [color = blue]\n"}}}return e+="}\n",{code:e,link:"https://chart.googleapis.com/chart?chl="+escape(e.replace("/ /g","+"))+"&cht=gv"}},standalone:function(){this.optimized||this.optimize();for(var t=this.optimized.data,e="function (input) {\n",n=0;n<t.inputs;n++)e+="F["+t.inputs[n]+"] = input["+n+"];\n";for(var n=0;n<t.activate.length;n++)for(var i=0;i<t.activate[n].length;i++)e+=t.activate[n][i].join("")+"\n";e+="var output = [];\n";for(var n=0;n<t.outputs.length;n++)e+="output["+n+"] = F["+t.outputs[n]+"];\n";e+="return output;\n}";for(var r=e.match(/F\[(\d+)\]/g),o=0,s={},n=0;n<r.length;n++){var a=r[n].match(/\d+/)[0];a in s||(s[a]=o++)}var c="F = {\n";for(var n in s)c+=s[n]+": "+this.optimized.memory[n]+",\n";return c=c.substring(0,c.length-2)+"\n};\n",c="var run = "+e.replace(/F\[(\d+)]/g,function(t){return"F["+s[t.match(/\d+/)[0]]+"]"}).replace("{\n","{\n"+c)+";\n",c+="return run",new Function(c)()},worker:function(t,n,i){var r={};i&&(r=i),r.rate=i.rate||.2,r.iterations=i.iterations||1e5,r.error=i.error||.005,r.cost=i.cost||null,r.crossValidate=i.crossValidate||null,costFunction="var cost = "+(i&&i.cost||this.cost||o.cost.MSE)+";\n";var s=e.getWorkerSharedFunctions();s=s.replace(/var cost = options && options\.cost \|\| this\.cost \|\| Trainer\.cost\.MSE;/g,costFunction),s=s.replace("return results;",'postMessage({action: "done", message: results, memoryBuffer: F}, [F.buffer]);'),s=s.replace("console.log('iterations', iterations, 'error', error, 'rate', currentRate)","postMessage({action: 'log', message: {\niterations: iterations,\nerror: error,\nrate: currentRate\n}\n})"),s=s.replace("abort = this.schedule.do({ error: error, iterations: iterations, rate: currentRate })","postMessage({action: 'schedule', message: {\niterations: iterations,\nerror: error,\nrate: currentRate\n}\n})"),this.optimized||this.optimize();var a="var inputs = "+this.optimized.data.inputs.length+";\n";a+="var outputs = "+this.optimized.data.outputs.length+";\n",a+="var F =  new Float64Array(["+this.optimized.memory.toString()+"]);\n",a+="var activate = "+this.optimized.activate.toString()+";\n",a+="var propagate = "+this.optimized.propagate.toString()+";\n",a+="onmessage = function(e) {\nif (e.data.action == 'startTraining') {\ntrain("+JSON.stringify(n)+","+JSON.stringify(r)+");\n}\n}";var c=s+"\n"+a,h=new Blob([c]),u=window.URL.createObjectURL(h);return new Worker(u)},clone:function(){return e.fromJSON(this.toJSON())}},e.getWorkerSharedFunctions=function(){if("undefined"!=typeof e._SHARED_WORKER_FUNCTIONS)return e._SHARED_WORKER_FUNCTIONS;var t=o.prototype.train.toString();t=t.replace("function (set","function train(set")+"\n";var n=o.prototype._trainSet.toString().replace(/this.network./g,"");n=n.replace("function (set","function _trainSet(set")+"\n",n=n.replace("this.crossValidate","crossValidate"),n=n.replace("crossValidate = true","crossValidate = { }");var i=o.prototype.test.toString().replace(/this.network./g,"");return i=i.replace("function (set","function test(set")+"\n",e._SHARED_WORKER_FUNCTIONS=t+n+i},e.fromJSON=function(t){for(var n=[],o={input:new r,hidden:[],output:new r},s=0;s<t.neurons.length;s++){var a=t.neurons[s],c=new i;c.trace.elegibility={},c.trace.extended={},c.state=a.state,c.old=a.old,c.activation=a.activation,c.bias=a.bias,c.squash=a.squash in i.squash?i.squash[a.squash]:i.squash.LOGISTIC,n.push(c),"input"==a.layer?o.input.add(c):"output"==a.layer?o.output.add(c):("undefined"==typeof o.hidden[a.layer]&&(o.hidden[a.layer]=new r),o.hidden[a.layer].add(c))}for(var s=0;s<t.connections.length;s++){var a=t.connections[s],h=n[a.from],u=n[a.to],p=a.weight,l=n[a.gater],f=h.project(u,p);l&&l.gate(f)}return new e(o)}}).call(e,n(2)(t))},function(t,e,n){(function(t){function e(t){for(var e,n,i=t.length;i;e=Math.floor(Math.random()*i),n=t[--i],t[i]=t[e],t[e]=n);return t}function n(t,e){e=e||{},this.network=t,this.rate=e.rate||.2,this.iterations=e.iterations||1e5,this.error=e.error||.005,this.cost=e.cost||null,this.crossValidate=e.crossValidate||null}t&&(t.exports=n),n.prototype={train:function(t,i){var r,o,s,a=1,c=f=0,h=!1,u=i&&i.cost||this.cost||n.cost.MSE,p=!1,l=Date.now();if(i&&(i.iterations&&(this.iterations=i.iterations),i.error&&(this.error=i.error),i.rate&&(this.rate=i.rate),i.cost&&(this.cost=i.cost),i.schedule&&(this.schedule=i.schedule),i.customLog&&(console.log("Deprecated: use schedule instead of customLog"),this.schedule=i.customLog),(this.crossValidate||i.crossValidate)&&(this.crossValidate||(this.crossValidate={}),p=!0,i.crossValidate.testSize&&(this.crossValidate.testSize=i.crossValidate.testSize),i.crossValidate.testError&&(this.crossValidate.testError=i.crossValidate.testError))),r=this.rate,Array.isArray(this.rate))var f=Math.floor(this.iterations/this.rate.length);if(p){var d=Math.ceil((1-this.crossValidate.testSize)*t.length);s=t.slice(0,d),o=t.slice(d)}for(var v=0;!h&&c<this.iterations&&a>this.error&&!(p&&a<=this.crossValidate.testError);){var g=t.length;if(a=0,c++,f>0){var y=Math.floor(c/f);r=this.rate[y]||r}"function"==typeof this.rate&&(r=this.rate(c,v)),p?(this._trainSet(s,r,u),a+=this.test(o).error,g=1):(a+=this._trainSet(t,r,u),g=t.length),a/=g,v=a,i&&(this.schedule&&this.schedule.every&&c%this.schedule.every==0?h=this.schedule.do({error:a,iterations:c,rate:r}):i.log&&c%i.log==0&&console.log("iterations",c,"error",a,"rate",r),i.shuffle&&e(t))}var m={error:a,iterations:c,time:Date.now()-l};return m},trainAsync:function(t,e){var n=this.workerTrain.bind(this);return new Promise(function(i,r){try{n(t,i,e,!0)}catch(t){r(t)}})},_trainSet:function(t,e,n){for(var i=0,r=0;r<t.length;r++){var o=t[r].input,s=t[r].output,a=this.network.activate(o);this.network.propagate(e,s),i+=n(s,a)}return i},test:function(t,e){for(var i,r,o,s=0,a=e&&e.cost||this.cost||n.cost.MSE,c=Date.now(),h=0;h<t.length;h++)i=t[h].input,o=t[h].output,r=this.network.activate(i),s+=a(o,r);s/=t.length;var u={error:s,time:Date.now()-c};return u},workerTrain:function(t,e,n,i){i||console.warn("Deprecated: do not use `workerTrain`, use `trainAsync` instead.");var r=this;this.network.optimized||this.network.optimize();var o=this.network.worker(this.network.optimized.memory,t,n);o.onmessage=function(t){switch(t.data.action){case"done":var i=t.data.message.iterations,s=t.data.message.error,a=t.data.message.time;r.network.optimized.ownership(t.data.memoryBuffer),e({error:s,iterations:i,time:a}),o.terminate();break;case"log":console.log(t.data.message);case"schedule":if(n&&n.schedule&&"function"==typeof n.schedule.do){var c=n.schedule.do;c(t.data.message)}}},o.postMessage({action:"startTraining"})},XOR:function(t){if(2!=this.network.inputs()||1!=this.network.outputs())throw new Error("Incompatible network (2 inputs, 1 output)");var e={iterations:1e5,log:!1,shuffle:!0,cost:n.cost.MSE};if(t)for(var i in t)e[i]=t[i];return this.train([{input:[0,0],output:[0]},{input:[1,0],output:[1]},{input:[0,1],output:[1]},{input:[1,1],output:[0]}],e)},DSR:function(t){t=t||{};var e,i,r,o,s,a=t.targets||[2,4,7,8],c=t.distractors||[3,5,6,9],h=t.prompts||[0,1],u=t.length||24,p=t.success||.95,l=t.iterations||1e5,f=t.rate||.1,d=t.log||0,v=t.schedule||{},g=t.cost||this.cost||n.cost.CROSS_ENTROPY;e=i=r=o=s=0;for(var y=1,m=a.length+c.length+h.length,w=function(t,e){var n=Math.random()*t|0,i=!1;for(var r in e)n==e[r]&&(i=!0);return i?w(t,e):n},T=function(t,e){for(var n in t)if(Math.round(t[n])!=e[n])return!1;return!0},b=Date.now();e<l&&(s<p||e%1e3!=0);){var I=[],D=u-h.length;for(r=0;r<D;r++){var _=Math.random()*c.length|0;I.push(c[_])}var O=[],E=[];for(r=0;r<h.length;r++)O.push(Math.random()*a.length|0),E.push(w(D,E));for(E=E.sort(),r=0;r<h.length;r++)I[E[r]]=a[O[r]],I.push(h[r]);var z,j=z=0;for(y=0,r=0;r<u;r++){var L=[];for(o=0;o<m;o++)L[o]=0;L[I[r]]=1;var S=[];for(o=0;o<a.length;o++)S[o]=0;if(r>=D){var x=r-D;S[O[x]]=1}var N=this.network.activate(L);T(N,S)?r<D?z++:j++:this.network.propagate(f,S),y+=g(S,N),z+j==u&&i++}e%1e3==0&&(i=0),e++;var A=e%1e3;A=0==A?1e3:A,s=i/A,y/=u,d&&e%d==0&&console.log("iterations:",e," success:",s," correct:",i," time:",Date.now()-b," error:",y),v.do&&v.every&&e%v.every==0&&v.do({iterations:e,success:s,error:y,time:Date.now()-b,correct:i})}return{iterations:e,success:s,error:y,time:Date.now()-b}},ERG:function(t){t=t||{};var e=t.iterations||15e4,i=t.error||.05,r=t.rate||.1,o=t.log||500,s=t.cost||this.cost||n.cost.CROSS_ENTROPY,a=function(){this.paths=[]};a.prototype={connect:function(t,e){return this.paths.push({node:t,value:e}),this},any:function(){if(0==this.paths.length)return!1;var t=Math.random()*this.paths.length|0;return this.paths[t]},test:function(t){for(var e in this.paths)if(this.paths[e].value==t)return this.paths[e];return!1}};for(var c=function(){var t=new a,e=(new a).connect(t,"E"),n=(new a).connect(e,"S"),i=(new a).connect(e,"V").connect(n,"P"),r=(new a).connect(n,"X");r.connect(r,"S");var o=(new a).connect(i,"V");o.connect(o,"T"),n.connect(o,"X");var s=(new a).connect(r,"T").connect(o,"P"),c=(new a).connect(s,"B");return{input:c,output:t}},h=function(){var t=c(),e=c(),n=new a,i=(new a).connect(n,"E");
t.output.connect(i,"T"),e.output.connect(i,"P");var r=(new a).connect(t.input,"P").connect(e.input,"T"),o=(new a).connect(r,"B");return{input:o,output:n}},u=function(){for(var t=h().input,e=t.any(),n="";e;)n+=e.value,e=e.node.any();return n},p=function(t){for(var e=h().input,n=0,i=t.charAt(n);n<t.length;){var r=e.test(i);if(!r)return!1;e=r.node,i=t.charAt(++n)}return!0},l=function(t,e){var n=0,i=-1,r=0,o=-1;for(var s in t)t[s]>n&&(n=t[s],i=s),e[s]>r&&(r=e[s],o=s);return i!=o},f=0,d=1,v={B:0,P:1,T:2,X:3,S:4,E:5},g=Date.now();f<e&&d>i;){var y=0;d=0;for(var m=u(),w=m.charAt(y),T=m.charAt(y+1);y<m.length-1;){for(var b=[],I=[],D=0;D<6;D++)b[D]=0,I[D]=0;b[v[w]]=1,I[v[T]]=1;var _=this.network.activate(b);l(_,I)&&this.network.propagate(r,I),w=m.charAt(++y),T=m.charAt(y+1),d+=s(I,_)}d/=m.length,f++,f%o==0&&console.log("iterations:",f," time:",Date.now()-g," error:",d)}return{iterations:f,error:d,time:Date.now()-g,test:p,generate:u}},timingTask:function(t){function e(t,e){for(var n=t+e,i=0,r=[],o=0;o<n;o++)r.push({input:[0,0],output:[0]});for(;i<n-20;){var s=Math.round(20*Math.random());r[i].input[0]=1;for(var a=i;a<=i+s;a++)r[a].input[1]=s/20,r[a].output[0]=.5;i+=s,s=Math.round(20*Math.random());for(var c=i+1;c<=i+s&&c<n;c++)r[c].input[1]=r[i].input[1];i+=s}for(var h=[],u=[],p=0;p<n;p++)(p<t?h:u).push(r[p]);return{train:h,test:u}}if(2!=this.network.inputs()||1!=this.network.outputs())throw new Error("Invalid Network: must have 2 inputs and one output");"undefined"==typeof t&&(t={});var i=t.iterations||200,r=t.error||.005,o=t.rate||[.03,.02],s=t.log!==!1&&(t.log||10),a=t.cost||this.cost||n.cost.MSE,c=t.trainSamples||7e3,h=t.trainSamples||1e3,u=e(c,h),p=this.train(u.train,{rate:o,log:s,iterations:i,error:r,cost:a});return{train:p,test:this.test(u.test)}}},n.cost={CROSS_ENTROPY:function(t,e){var n=0;for(var i in e)n-=t[i]*Math.log(e[i]+1e-15)+(1-t[i])*Math.log(1+1e-15-e[i]);return n},MSE:function(t,e){for(var n=0,i=0;i<e.length;i++)n+=Math.pow(t[i]-e[i],2);return n/e.length},BINARY:function(t,e){for(var n=0,i=0;i<e.length;i++)n+=Math.round(2*t[i])!=Math.round(2*e[i]);return n}}}).call(e,n(2)(t))},function(t,e,n){(function(t){var e=n(3),i=n(4),r=n(5),o={Perceptron:function(){var t=Array.prototype.slice.call(arguments);if(t.length<3)throw new Error("not enough layers (minimum 3) !!");for(var n=t.shift(),i=t.pop(),r=t,o=new e(n),s=[],a=new e(i),c=o,h=0;h<r.length;h++){var u=r[h],p=new e(u);s.push(p),c.project(p),c=p}c.project(a),this.set({input:o,hidden:s,output:a})},LSTM:function(){var t=Array.prototype.slice.call(arguments);if(t.length<3)throw new Error("not enough layers (minimum 3) !!");var n=t.pop(),i={peepholes:e.connectionType.ALL_TO_ALL,hiddenToHidden:!1,outputToHidden:!1,outputToGates:!1,inputToOutput:!0};if("number"!=typeof n){var r=t.pop();n.hasOwnProperty("peepholes")&&(i.peepholes=n.peepholes),n.hasOwnProperty("hiddenToHidden")&&(i.hiddenToHidden=n.hiddenToHidden),n.hasOwnProperty("outputToHidden")&&(i.outputToHidden=n.outputToHidden),n.hasOwnProperty("outputToGates")&&(i.outputToGates=n.outputToGates),n.hasOwnProperty("inputToOutput")&&(i.inputToOutput=n.inputToOutput)}else var r=n;for(var o=t.shift(),s=t,a=new e(o),c=[],h=new e(r),u=null,p=0;p<s.length;p++){var l=s[p],f=new e(l).set({bias:1}),d=new e(l).set({bias:1}),v=new e(l),g=new e(l).set({bias:1});c.push(f),c.push(d),c.push(v),c.push(g);var y=a.project(v);if(a.project(f),a.project(d),a.project(g),null!=u){var m=u.project(v);u.project(f),u.project(d),u.project(g)}var w=v.project(h),T=v.project(v);i.hiddenToHidden&&v.project(v,e.connectionType.ALL_TO_ELSE),i.outputToHidden&&h.project(v),i.outputToGates&&(h.project(f),h.project(g),h.project(d)),v.project(f,i.peepholes),v.project(d,i.peepholes),v.project(g,i.peepholes),f.gate(y,e.gateType.INPUT),d.gate(T,e.gateType.ONE_TO_ONE),g.gate(w,e.gateType.OUTPUT),null!=u&&f.gate(m,e.gateType.INPUT),u=v}i.inputToOutput&&a.project(h),this.set({input:a,hidden:c,output:h})},Liquid:function(t,n,i,r,o){for(var s=new e(t),a=new e(n),c=new e(i),h=a.neurons(),u=[],p=0;p<r;p++){var l=Math.random()*h.length|0,f=Math.random()*h.length|0,d=h[l].project(h[f]);u.push(d)}for(var v=0;v<o;v++){var g=Math.random()*h.length|0,d=Math.random()*u.length|0;h[g].gate(u[d])}s.project(a),a.project(c),this.set({input:s,hidden:[a],output:c})},Hopfield:function(t){var n=new e(t),i=new e(t);n.project(i,e.connectionType.ALL_TO_ALL),this.set({input:n,hidden:[],output:i});var s=new r(this),a=o.Hopfield.prototype;a.learn=a.learn||function(t){var e=[];for(var n in t)e.push({input:t[n],output:t[n]});return s.train(e,{iterations:5e5,error:5e-5,rate:1})},a.feed=a.feed||function(t){var e=this.activate(t),t=[];for(var n in e)t[n]=e[n]>.5?1:0;return t}}};for(var s in o)o[s].prototype=new i,o[s].prototype.constructor=o[s];t&&(t.exports=o)}).call(e,n(2)(t))}])});