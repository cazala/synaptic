/*

The MIT License (MIT)

Copyright (c) 2014 Juan Cazala - juancazala.com

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE



********************************************************************************************
                                         SYNAPTIC
********************************************************************************************

Synaptic is a javascript neural network library for node.js and the browser, its generalized
algorithm is architecture-free, so you can build and train basically any type of first order
or even second order neural network architectures.

http://en.wikipedia.org/wiki/Recurrent_neural_network#Second_Order_Recurrent_Neural_Network

The library includes a few built-in architectures like multilayer perceptrons, multilayer
long-short term memory networks (LSTM) or liquid state machines, and a trainer capable of
training any given network, and includes built-in training tasks/tests like solving an XOR,
passing a Distracted Sequence Recall test or an Embeded Reber Grammar test.

The algorithm implemented by this library has been taken from Derek D. Monner's paper:


A generalized LSTM-like training algorithm for second-order recurrent neural networks
http://www.overcomplete.net/papers/nn2012.pdf

There are references to the equations in that paper commented through the source code.


********************************************************************************************/
!function t(e,n,i){function r(a,s){if(!n[a]){if(!e[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(o)return o(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var u=n[a]={exports:{}};e[a][0].call(u.exports,function(t){var n=e[a][1][t];return r(n?n:t)},u,u.exports,t,e,n,i)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<i.length;a++)r(i[a]);return r}({1:[function(t,e,n){var i=t("./architect/hopfield"),r=t("./architect/LSTM"),o=t("./architect/Liquid"),a=t("./architect/Perceptron");n.LSTM=r.LSTM,n.Liquid=o.Liquid,n.Hopfield=i.Hopfield,n.Perceptron=a.Perceptron},{"./architect/LSTM":2,"./architect/Liquid":3,"./architect/Perceptron":4,"./architect/hopfield":5}],2:[function(t,e,n){var i=this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);n.prototype=e.prototype,t.prototype=new n},r=t("../network"),o=t("../trainer"),a=t("../layer"),s=function(t){function e(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(e.length<3)throw"Error: not enough layers (minimum 3) !!";var i=e.pop(),r={peepholes:a.Layer.connectionType.ALL_TO_ALL,hiddentohidden:!1,outtohidden:!1,outtogates:!1,intoout:!0};if("number"!=typeof i){var s=e.pop();i.hasOwnProperty("peepholes")&&(r.peepholes=i.peepholes),i.hasOwnProperty("hiddentohidden")&&(r.hiddentohidden=i.hiddentohidden),i.hasOwnProperty("outtohidden")&&(r.outtohidden=i.outtohidden),i.hasOwnProperty("outtogates")&&(r.outtogates=i.outtogates),i.hasOwnProperty("intoout")&&(r.intoout=i.intoout)}else var s=i;var c=e.shift(),h=e,u=new a.Layer(c),p=[],f=new a.Layer(s),l=null;for(var v in h){var d=h[v],g=new a.Layer(d).set({bias:1}),y=new a.Layer(d).set({bias:1}),m=new a.Layer(d),w=new a.Layer(d).set({bias:1});p.push(g),p.push(y),p.push(m),p.push(w);var b=u.project(m);if(u.project(g),u.project(y),u.project(w),null!=l){var I=l.project(m);l.project(g),l.project(y),l.project(w)}var T=m.project(f),L=m.project(m);r.hiddentohidden&&m.project(m,a.Layer.connectionType.ALL_TO_ELSE),r.outtohidden&&f.project(m),r.outtogates&&(f.project(g),f.project(w),f.project(y)),m.project(g,r.peepholes),m.project(y,r.peepholes),m.project(w,r.peepholes),g.gate(b,a.Layer.gateType.INPUT),y.gate(L,a.Layer.gateType.ONE_TO_ONE),w.gate(T,a.Layer.gateType.OUTPUT),null!=l&&g.gate(I,a.Layer.gateType.INPUT),l=m}r.intoout&&u.project(f),t.call(this,{input:u,hidden:p,output:f}),this.trainer=new o.Trainer(this)}return i(e,t),e}(r.Network);n.LSTM=s},{"../layer":6,"../network":7,"../trainer":11}],3:[function(t,e,n){var i=this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);n.prototype=e.prototype,t.prototype=new n},r=t("../network"),o=t("../trainer"),a=t("../layer"),s=function(t){function e(e,n,i,r,s){for(var c=new a.Layer(e),h=new a.Layer(n),u=new a.Layer(i),p=h.neurons(),f=[],l=0;r>l;l++){var v=Math.random()*p.length|0,d=Math.random()*p.length|0,g=p[v].project(p[d]);f.push(g)}for(var y=0;s>y;y++){var m=Math.random()*p.length|0,w=Math.random()*f.length|0;p[m].gate(f[w])}c.project(h),h.project(u),t.call(this,{input:c,hidden:[h],output:u}),this.trainer=new o.Trainer(this)}return i(e,t),e}(r.Network);n.Liquid=s},{"../layer":6,"../network":7,"../trainer":11}],4:[function(t,e,n){var i=this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);n.prototype=e.prototype,t.prototype=new n},r=t("../network"),o=t("../trainer"),a=t("../layer"),s=function(t){function e(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(e.length<3)throw"Error: not enough layers (minimum 3) !!";var i=e.shift(),r=e.pop(),s=e,c=new a.Layer(i),h=[],u=new a.Layer(r),p=c;for(var f in s){var l=s[f],v=new a.Layer(l);h.push(v),p.project(v),p=v}p.project(u),t.call(this,{input:c,hidden:h,output:u}),this.trainer=new o.Trainer(this)}return i(e,t),e}(r.Network);n.Perceptron=s},{"../layer":6,"../network":7,"../trainer":11}],5:[function(t,e,n){var i=this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);n.prototype=e.prototype,t.prototype=new n},r=t("../network"),o=t("../trainer"),a=t("../layer"),s=function(t){function e(e){var n=new a.Layer(e),i=new a.Layer(e);n.project(i,a.Layer.connectionType.ALL_TO_ALL),t.call(this,{input:n,hidden:[],output:i}),this.trainer=new o.Trainer(this)}return i(e,t),e.prototype.learn=function(t){var e=[];for(var n in t)e.push({input:t[n],output:t[n]});return this.trainer.train(e,{iterations:5e5,error:5e-5,rate:1})},e.prototype.feed=function(t){var e=this.activate(t),n=[];for(var i in e)n[i]=e[i]>.5?1:0;return n},e}(r.Network);n.Hopfield=s},{"../layer":6,"../network":7,"../trainer":11}],6:[function(t,e,n){var i=t("./neuron"),r=t("./network"),o=function(){function t(t,e){for(this.list=[],this.label=null,this.connectedto=[],this.size=0,this.size=0|t,this.list=[],this.label=e||null,this.connectedto=[];t--;){var n=new i.Neuron;this.list.push(n)}}return t.prototype.activate=function(t){var e=[];if("undefined"!=typeof t){if(t.length!=this.size)throw"INPUT size and LAYER size must be the same to activate!";for(var n in this.list){var i=this.list[n],r=i.activate(t[n]);e.push(r)}}else for(var n in this.list){var i=this.list[n],r=i.activate();e.push(r)}return e},t.prototype.propagate=function(t,e){if("undefined"!=typeof e){if(e.length!=this.size)throw"TARGET size and LAYER size must be the same to propagate!";for(var n=this.list.length-1;n>=0;n--){var i=this.list[n];i.propagate(t,e[n])}}else for(var n=this.list.length-1;n>=0;n--){var i=this.list[n];i.propagate(t)}},t.prototype.project=function(e,n,i){if(e instanceof r.Network&&(e=e.layers.input),!(e instanceof t))throw"Invalid argument, you can only project connections to LAYERS and NETWORKS!";return this.connected(e)?void 0:new t.LayerConnection(this,e,n,i)},t.prototype.gate=function(e,n){if(n==t.gateType.INPUT){if(e.to.size!=this.size)throw"GATER layer and CONNECTION.TO layer must be the same size in order to gate!";for(var i in e.to.list){var r=e.to.list[i],o=this.list[i];for(var a in r.connections.inputs){var s=r.connections.inputs[a];s.ID in e.connections&&o.gate(s)}}}else if(n==t.gateType.OUTPUT){if(e.from.size!=this.size)throw"GATER layer and CONNECTION.FROM layer must be the same size in order to gate!";for(var i in e.from.list){var r=e.from.list[i],o=this.list[i];for(var c in r.connections.projected){var s=r.connections.projected[c];s.ID in e.connections&&o.gate(s)}}}else if(n==t.gateType.ONE_TO_ONE){if(e.size!=this.size)throw"The number of GATER UNITS must be the same as the number of CONNECTIONS to gate!";for(var i in e.list){var o=this.list[i],s=e.list[i];o.gate(s)}}e.gatedfrom.push({layer:this,type:n})},t.prototype.selfconnected=function(){for(var t in this.list){var e=this.list[t];if(!e.selfconnected())return!1}return!0},t.prototype.connected=function(e){var n=0;for(var i in this.list)for(var r in e.list){var o=this.list[i],a=e.list[r],s=o.connected(a);s&&"projected"==s.type&&n++}if(n==this.size*e.size)return t.connectionType.ALL_TO_ALL;n=0;for(var c in this.list){var o=this.list[c],a=e.list[c],s=o.connected(a);s&&"projected"==s.type&&n++}return n==this.size?t.connectionType.ONE_TO_ONE:void 0},t.prototype.clear=function(){for(var t in this.list){var e=this.list[t];e.clear()}},t.prototype.reset=function(){for(var t in this.list){var e=this.list[t];e.reset()}},t.prototype.neurons=function(){return this.list},t.prototype.add=function(t){t=t||new t.Neuron,this.neurons[t.ID]=t,this.list.push(t),this.size++},t.prototype.set=function(t){t=t||{};for(var e in this.list){var n=this.list[e];t.label&&(n.label=t.label+"_"+n.ID),t.squash&&(n.squash=t.squash),t.bias&&(n.bias=t.bias)}return this},t}();n.Layer=o;var o;!function(t){function e(){return t.layerQty++}t.layerQty=0,t.uid=e,t.connectionType={ALL_TO_ALL:"ALL TO ALL",ONE_TO_ONE:"ONE TO ONE",ALL_TO_ELSE:"ALL TO ELSE"},t.gateType={INPUT:"INPUT",OUTPUT:"OUTPUT",ONE_TO_ONE:"ONE TO ONE"};var n=function(){function n(n,i,r,o){if(this.ID=e(),this.selfconnection=!1,this.size=0,this.gatedfrom=[],this.from=n,this.to=i,this.selfconnection=i==n,this.type=r,this.connections={},this.list=[],this.size=0,this.gatedfrom=[],"undefined"==typeof this.type&&(this.type=n==i?t.connectionType.ONE_TO_ONE:t.connectionType.ALL_TO_ALL),this.type==t.connectionType.ALL_TO_ALL||this.type==t.connectionType.ALL_TO_ELSE)for(var a in this.from.list)for(var s in this.to.list){var c=this.from.list[a],h=this.to.list[s];if(this.type!=t.connectionType.ALL_TO_ELSE||c!=h){var u=c.project(h,o);this.connections[u.ID]=u,this.size=this.list.push(u)}}else if(this.type==t.connectionType.ONE_TO_ONE)for(var p in this.from.list){var c=this.from.list[p],h=this.to.list[p],u=c.project(h,o);this.connections[u.ID]=u,this.size=this.list.push(u)}n.connectedto.push(this)}return n}();t.LayerConnection=n}(o=n.Layer||(n.Layer={}))},{"./network":7,"./neuron":8}],7:[function(t,e,n){var i=t("./layer"),r=t("./squash"),o=t("./neuron"),a=function(){function t(t){this.optimized=null,this.layers={input:null,hidden:{},output:null},"undefined"!=typeof t&&(this.layers=t||{input:null,hidden:{},output:null},this.optimized=null)}return t.prototype.activate=function(t){if(this.optimized===!1){this.layers.input.activate(t);for(var e in this.layers.hidden)this.layers.hidden[e].activate();return this.layers.output.activate()}return null==this.optimized&&this.optimize(),this.optimized.activate(t)},t.prototype.propagate=function(t,e){if(this.optimized===!1){this.layers.output.propagate(t,e);var n=[];for(var i in this.layers.hidden)n.push(this.layers.hidden[i]);n.reverse();for(var i in n)n[i].propagate(t)}else null==this.optimized&&this.optimize(),this.optimized.propagate(t,e)},t.prototype.project=function(e,n,r){if(this.optimized&&this.optimized.reset(),e instanceof t)return this.layers.output.project(e.layers.input,n,r);if(e instanceof i.Layer)return this.layers.output.project(e,n,r);throw"Invalid argument, you can only project connections to LAYERS and NETWORKS!"},t.prototype.gate=function(t,e){this.optimized&&this.optimized.reset(),this.layers.output.gate(t,e)},t.prototype.clear=function(){this.restore();var t=this.layers.input,e=this.layers.output;t.clear();for(var n in this.layers.hidden){var i=this.layers.hidden[n];i.clear()}e.clear(),this.optimized&&this.optimized.reset()},t.prototype.reset=function(){this.restore();var t=this.layers.input,e=this.layers.output;t.reset();for(var n in this.layers.hidden){var i=this.layers.hidden[n];i.reset()}e.reset(),this.optimized&&this.optimized.reset()},t.prototype.optimize=function(){var t=this,e={},n=this.neurons();for(var i in n){var r=n[i].neuron,o=n[i].layer;e=r.optimize(e,o)}for(var i in e.propagation_sentences)e.propagation_sentences[i].reverse();e.propagation_sentences.reverse();var a="";a+="var F = Float64Array ? new Float64Array("+e.memory+") : []; ";for(var i in e.variables)a+="F["+e.variables[i].id+"] = "+(e.variables[i].value||0)+"; ";a+="var activate = function(input){\n",a+="influences = [];";for(var i in e.inputs)a+="F["+e.inputs[i]+"] = input["+i+"]; ";for(var s in e.activation_sentences)if(e.activation_sentences[s].length>0)for(var c in e.activation_sentences[s])a+=e.activation_sentences[s][c].join(" "),a+=e.trace_sentences[s][c].join(" ");a+=" var output = []; ";for(var i in e.outputs)a+="output["+i+"] = F["+e.outputs[i]+"]; ";a+="return output; }; ",a+="var propagate = function(rate, target){\n",a+="F["+e.variables.rate.id+"] = rate; ";for(var i in e.targets)a+="F["+e.targets[i]+"] = target["+i+"]; ";for(var s in e.propagation_sentences)for(var c in e.propagation_sentences[s])a+=e.propagation_sentences[s][c].join(" ")+" ";a+=" };\n",a+="var ownership = function(memoryBuffer){\nF = memoryBuffer;\nthis.memory = F;\n};\n",a+="return {\nmemory: F,\nactivate: activate,\npropagate: propagate,\nownership: ownership\n};",a=a.split(";").join(";\n");var h=new Function(a),u=h();u.data={variables:e.variables,activate:e.activation_sentences,propagate:e.propagation_sentences,trace:e.trace_sentences,inputs:e.inputs,outputs:e.outputs,check_activation:this.activate,check_propagation:this.propagate},u.reset=function(){t.optimized&&(t.optimized=null,t.activate=u.data.check_activation,t.propagate=u.data.check_propagation)},this.optimized=u,this.activate=u.activate,this.propagate=u.propagate},t.prototype.restore=function(){if(this.optimized){var t=this.optimized,e=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var i=e.shift(),r=e.pop(),o=r+"_";for(var a in e)o+=e[a]+"_";o+=i.ID;var s=t.memory,c=t.data.variables;return o in c?s[c[o].id]:0},n=this.neurons();for(var i in n){var r=n[i].neuron;r.state=e(r,"state"),r.old=e(r,"old"),r.activation=e(r,"activation"),r.bias=e(r,"bias");for(var o in r.trace.elegibility)r.trace.elegibility[o]=e(r,"trace","elegibility",o);for(var a in r.trace.extended)for(var o in r.trace.extended[a])r.trace.extended[a][o]=e(r,"trace","extended",a,o)}for(var i in n){var r=n[i].neuron;for(var s in r.connections.projected){var c=r.connections.projected[s];c.weight=e(c,"weight"),c.gain=e(c,"gain")}}}},t.prototype.neurons=function(){var t=[],e=this.layers.input.neurons(),n=this.layers.output.neurons();for(var i in e)t.push({neuron:e[i],layer:"input"});for(var r in this.layers.hidden){var o=this.layers.hidden[r].neurons();for(var i in o)t.push({neuron:o[i],layer:r})}for(var i in n)t.push({neuron:n[i],layer:"output"});return t},t.prototype.inputs=function(){return this.layers.input.size},t.prototype.outputs=function(){return this.layers.output.size},t.prototype.set=function(t){this.layers=t,this.optimized&&this.optimized.reset()},t.prototype.setOptimize=function(t){this.restore(),this.optimized&&this.optimized.reset(),this.optimized=t?null:!1},t.prototype.toJSON=function(t){this.restore();var e=this.neurons(),n=[],i=[],o={};for(var a in e){var s=e[a].neuron;o[s.ID]=a;var c={trace:{elegibility:{},extended:{}},state:s.state,old:s.old,activation:s.activation,bias:s.bias,layer:e[a].layer,squash:null};c.squash=s.squash==r.LOGISTIC?"LOGISTIC":s.squash==r.TANH?"TANH":s.squash==r.IDENTITY?"IDENTITY":s.squash==r.HLIM?"HLIM":null,n.push(c)}if(!t)for(var a in n){var h=n[a];for(var u in s.trace.elegibility)h.trace.elegibility[u]=s.trace.elegibility[u];for(var p in s.trace.extended){h.trace.extended[p]={};for(var u in s.trace.extended[p])h.trace.extended[o[p]][u]=s.trace.extended[p][u]}}for(var a in e){var s=e[a].neuron;for(var f in s.connections.projected){var l=s.connections.projected[f];i.push({from:o[l.from.ID],to:o[l.to.ID],weight:l.weight,gater:l.gater?o[l.gater.ID]:null})}s.selfconnected()&&i.push({from:o[s.ID],to:o[s.ID],weight:s.selfconnection.weight,gater:s.selfconnection.gater?o[s.selfconnection.gater.ID]:null})}return{neurons:n,connections:i}},t.prototype.toDot=function(t){var e="digraph nn {\n    rankdir = BT\n",n=[this.layers.input].concat(this.layers.hidden,this.layers.output);for(var i in n)for(var r in n[i].connectedto){var o=n[i].connectedto[r],a=o.to,s=o.size,c=n.indexOf(n[i]),h=n.indexOf(a);if(t){if(o.gatedfrom.length){var u="fake"+c+"_"+h;e+="    "+u+' [label = "", shape = point, width = 0.01, height = 0.01]\n',e+="    "+c+" -> "+u+" [label = "+s+", arrowhead = none]\n",e+="    "+u+" -> "+h+"\n"}else e+="    "+c+" -> "+h+" [label = "+s+"]\n";for(var p in o.gatedfrom){var f=o.gatedfrom[p].layer,l=(o.gatedfrom[p].type,n.indexOf(f));e+="    "+l+" -> "+u+" [color = blue]\n"}}else{e+="    "+c+" -> "+h+" [label = "+s+"]\n";for(var p in o.gatedfrom){var f=o.gatedfrom[p].layer,l=(o.gatedfrom[p].type,n.indexOf(f));e+="    "+l+" -> "+h+" [color = blue]\n"}}}return e+="}\n",{code:e,link:"https://chart.googleapis.com/chart?chl="+escape(e.replace("/ /g","+"))+"&cht=gv"}},t.prototype.standalone=function(){this.optimized||this.optimize();var t=this.optimized.data,e="function (input) {\n";for(var n in t.inputs)e+="F["+t.inputs[n]+"] = input["+n+"];\n";for(var i in t.activate)for(var r in t.activate[i])e+=t.activate[i][r]+"\n";e+="var output = [];\n";for(var n in t.outputs)e+="output["+n+"] = F["+t.outputs[n]+"];\n";e+="return output;\n}";var o=e.match(/F\[(\d+)\]/g),a=0,s={};for(var c in o){var h=o[c].match(/\d+/)[0];h in s||(s[h]=a++)}var u="F = {\n";for(var n in s)u+=s[n]+": "+this.optimized.memory[n]+",\n";return u=u.substring(0,u.length-2)+"\n};\n",u="var run = "+e.replace(/F\[(\d+)]/g,function(t){return"F["+s[t.match(/\d+/)[0]]+"]"}).replace("{\n","{\n"+u)+";\n",u+="return run",new Function(u)()},t.prototype.worker=function(){this.optimized||this.optimize();var t="var inputs = "+this.optimized.data.inputs.length+";\n";t+="var outputs = "+this.optimized.data.outputs.length+";\n",t+="var F = null;\n",t+="var activate = "+this.optimized.activate.toString()+";\n",t+="var propagate = "+this.optimized.propagate.toString()+";\n",t+="onmessage = function(e){\n",t+="F = e.data.memoryBuffer;\n",t+="if (e.data.action == 'activate'){\n",t+="if (e.data.input.length == inputs){\n",t+="postMessage( { action: 'activate', output: activate(e.data.input), memoryBuffer: F }, [F.buffer]);\n",t+="}\n}\nelse if (e.data.action == 'propagate'){\n",t+="propagate(e.data.rate, e.data.target);\n",t+="postMessage({ action: 'propagate', memoryBuffer: F }, [F.buffer]);\n",t+="}\n}\n";var e=new Blob([t]),n=window.URL.createObjectURL(e);return new Worker(n)},t.prototype.clone=function(e){return t.fromJSON(this.toJSON(e))},t.fromJSON=function(e){var n=[],a={input:new i.Layer(0),hidden:[],output:new i.Layer(0)};for(var s in e.neurons){var c=e.neurons[s],h=new o.Neuron;h.trace.elegibility=c.trace.elegibility,h.trace.extended=c.trace.extended,h.state=c.state,h.old=c.old,h.activation=c.activation,h.bias=c.bias,h.squash=c.squash in r?r[c.squash]:r.LOGISTIC,n.push(h),"input"==c.layer?a.input.add(h):"output"==c.layer?a.output.add(h):("undefined"==typeof a.hidden[c.layer]&&(a.hidden[c.layer]=new i.Layer(0)),a.hidden[c.layer].add(h))}for(var s in e.connections){var c=e.connections[s],u=n[c.from],p=n[c.to],f=c.weight,l=n[c.gater],v=u.project(p,f);l&&l.gate(v)}return new t(a)},t}();n.Network=a},{"./layer":6,"./neuron":8,"./squash":9}],8:[function(t,e,n){var i=t("./squash"),r=function(){function t(){this.ID=t.uid(),this.label=null,this.connections={inputs:{},projected:{},gated:{}},this.error={responsibility:0,projected:0,gated:0},this.trace={elegibility:{},extended:{},influences:{}},this.state=0,this.old=0,this.activation=0,this.selfconnection=new t.Connection(this,this,0),this.squash=i.LOGISTIC,this.neighboors={},this.bias=.2*Math.random()-.1,this.derivative=0}return t.prototype.activate=function(t){if("undefined"!=typeof t)return this.activation=t,this.derivative=0,this.bias=0,this.activation;this.old=this.state,this.state=this.selfconnection.gain*this.selfconnection.weight*this.state+this.bias;for(var e in this.connections.inputs){var n=this.connections.inputs[e];this.state+=n.from.activation*n.weight*n.gain}this.activation=this.squash(this.state),this.derivative=this.squash(this.state,!0);var i=[];for(var r in this.trace.extended){var o=this.trace.extended[r],a=this.neighboors[r],s=a.selfconnection.gater==this?a.old:0;for(var c in this.trace.influences[a.ID])s+=this.trace.influences[a.ID][c].weight*this.trace.influences[a.ID][c].from.activation;i[a.ID]=s}for(var e in this.connections.inputs){var n=this.connections.inputs[e];this.trace.elegibility[n.ID]=this.selfconnection.gain*this.selfconnection.weight*this.trace.elegibility[n.ID]+n.gain*n.from.activation;for(var r in this.trace.extended){var o=this.trace.extended[r],a=this.neighboors[r],s=i[a.ID];o[n.ID]=a.selfconnection.gain*a.selfconnection.weight*o[n.ID]+this.derivative*this.trace.elegibility[n.ID]*s}}for(var h in this.connections.gated)this.connections.gated[h].gain=this.activation;return this.activation},t.prototype.propagate=function(t,e){var n=0,i="undefined"!=typeof e&&null!=e;if(i)this.error.responsibility=this.error.projected=e-this.activation;else{for(var r in this.connections.projected){var o=this.connections.projected[r],a=o.to;n+=a.error.responsibility*o.gain*o.weight}this.error.projected=this.derivative*n,n=0;for(var r in this.trace.extended){var a=this.neighboors[r],s=a.selfconnection.gater==this?a.old:0;for(var c in this.trace.influences[r])s+=this.trace.influences[r][c].weight*this.trace.influences[a.ID][c].from.activation;n+=a.error.responsibility*s}this.error.gated=this.derivative*n,this.error.responsibility=this.error.projected+this.error.gated}t=t||.1;for(var r in this.connections.inputs){var h=this.connections.inputs[r],u=this.error.projected*this.trace.elegibility[h.ID];for(var r in this.trace.extended){var a=this.neighboors[r];u+=a.error.responsibility*this.trace.extended[a.ID][h.ID]}h.weight+=t*u}this.bias+=t*this.error.responsibility},t.prototype.project=function(e,n){if(e==this)return this.selfconnection.weight=1,this.selfconnection;var i=this.connected(e);if(i&&"projected"==i.type)return"undefined"!=typeof n&&(i.connection.weight=n),i.connection;var r=new t.Connection(this,e,n);this.connections.projected[r.ID]=r,this.neighboors[e.ID]=e,e.connections.inputs[r.ID]=r,e.trace.elegibility[r.ID]=0;for(var o in e.trace.extended){var a=e.trace.extended[o];a[r.ID]=0}return r},t.prototype.gate=function(t){this.connections.gated[t.ID]=t;var e=t.to;if(!(e.ID in this.trace.extended)){this.neighboors[e.ID]=e;var n=this.trace.extended[e.ID]={};for(var i in this.connections.inputs){var r=this.connections.inputs[i];n[r.ID]=0}}e.ID in this.trace.influences?this.trace.influences[e.ID].push(t):this.trace.influences[e.ID]=[t],t.gater=this},t.prototype.selfconnected=function(){return 0!==this.selfconnection.weight},t.prototype.connected=function(t){var e={type:null,connection:null};if(this==t)return this.selfconnected()?(e.type="selfconnection",e.connection=this.selfconnection,e):null;for(var n in this.connections)for(var i in this.connections[n]){var i=this.connections[n][i];if(i.to==t)return e.type=n,e.connection=i,e;if(i.from==t)return e.type=n,e.connection=i,e}return null},t.prototype.clear=function(){for(var t in this.trace.elegibility)this.trace.elegibility[t]=0;for(var t in this.trace.extended)for(var e in this.trace.extended[t])this.trace.extended[t][e]=0;this.error.responsibility=this.error.projected=this.error.gated=0},t.prototype.reset=function(){this.clear();for(var t in this.connections)for(var e in this.connections[t])this.connections[t][e].weight=.2*Math.random()-.1;this.bias=.2*Math.random()-.1,this.old=this.state=this.activation=0},t.prototype.optimize=function(t,e){t=t||{};var n=[],r=[],o=[],a=t.memory||0,s=t.neurons||1,c=t.inputs||[],h=t.targets||[],u=t.outputs||[],p=t.variables||{},f=t.activation_sentences||[],l=t.trace_sentences||[],v=t.propagation_sentences||[],d=t.layers||{__count:0,__neuron:0},g=function(t){var n=e in d&&t[d.__count];n||(d.__count=t.push([])-1,d[e]=d.__count)};g(f),g(l),g(v);var y=d.__count,m=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n;if(1==t.length)return"target"==t[0]?(n="target_"+h.length,h.push(a)):n=t[0],n in p?p[n]:p[n]={value:0,id:a++};var i=t.length>2;if(i)var r=t.pop();var o=t.shift(),s=t.pop();if(!i)var r=o[s];n=s+"_";for(var c in t)n+=t[c]+"_";return n+=o.ID,n in p?p[n]:p[n]={value:r,id:a++}},w=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=t.pop(),i="";for(var r in t)i+="string"==typeof t[r]?t[r]:"F["+t[r].id+"]";n.push(i+";")},b=function(t){for(var e in t)if(t.hasOwnProperty(e))return!1;return!0},I=b(this.connections.projected),T=b(this.connections.gated),L="input"==e?!0:b(this.connections.inputs),D="output"==e?!0:I&&T,_=m("rate"),O=m(this,"activation");if(L)c.push(O.id);else{f[y].push(n),l[y].push(r),v[y].push(o);var z=m(this,"old"),N=m(this,"state"),x=m(this,"bias");if(this.selfconnection.gater)var j=m(this.selfconnection,"gain");if(this.selfconnected())var E=m(this.selfconnection,"weight");w(z," = ",N,n),this.selfconnected()?this.selfconnection.gater?w(N," = ",j," * ",E," * ",N," + ",x,n):w(N," = ",E," * ",N," + ",x,n):w(N," = ",x,n);for(var k in this.connections.inputs){var M=this.connections.inputs[k],A=m(M.from,"activation"),S=m(M,"weight");if(M.gater)var q=m(M,"gain");this.connections.inputs[k].gater?w(N," += ",A," * ",S," * ",q,n):w(N," += ",A," * ",S,n)}var P=m(this,"derivative");switch(this.squash){case i.LOGISTIC:w(O," = (1 / (1 + Math.exp(-",N,")))",n),w(P," = ",O," * (1 - ",O,")",n);break;case i.TANH:var F=m("aux"),C=m("aux_2");w(F," = Math.exp(",N,")",n),w(C," = 1 / ",F,n),w(O," = (",F," - ",C,") / (",F," + ",C,")",n),w(P," = 1 - (",O," * ",O,")",n);break;case i.IDENTITY:w(O," = ",N,n),w(P," = 1",n);break;case i.HLIM:w(O," = +(",N," > 0)",n),w(P," = 1",n)}var R=[];for(var U in this.trace.extended){var B=this.trace.extended[U],G=this.neighboors[U],H=m("aux"),Y=m(G,"old"),Q=!1;G.selfconnection.gater==this&&(w(H," = ",Y,r),Q=!0);for(var J in this.trace.influences[G.ID]){var X=m(this.trace.influences[G.ID][J],"weight"),W=m(this.trace.influences[G.ID][J].from,"activation");Q?w(H," += ",X," * ",W,r):(w(H," = ",X," * ",W,r),Q=!0)}R.push(G.ID),w("influences["+(R.length-1)+"] = ",H,r)}for(var k in this.connections.inputs){var M=this.connections.inputs[k];if(M.gater)var q=m(M,"gain");var A=m(M.from,"activation"),K=m(this,"trace","elegibility",M.ID,this.trace.elegibility[M.ID]);this.selfconnected()?this.selfconnection.gater?M.gater?w(K," = ",j," * ",E," * ",K," + ",q," * ",A,r):w(K," = ",j," * ",E," * ",K," + ",A,r):M.gater?w(K," = ",E," * ",K," + ",q," * ",A,r):w(K," = ",E," * ",K," + ",A,r):M.gater?w(K," = ",q," * ",A,r):w(K," = ",A,r);for(var U in this.trace.extended){var B=this.trace.extended[U],G=this.neighboors[U],H=m("aux"),Y=m(G,"old"),K=m(this,"trace","elegibility",M.ID,this.trace.elegibility[M.ID]),B=m(this,"trace","extended",G.ID,M.ID,this.trace.extended[G.ID][M.ID]);if(G.selfconnected())var V=m(G.selfconnection,"weight");if(G.selfconnection.gater)var Z=m(G.selfconnection,"gain");G.selfconnected()?G.selfconnection.gater?w(B," = ",Z," * ",V," * ",B," + ",P," * ",K," * ","influences["+R.indexOf(G.ID)+"]",r):w(B," = ",V," * ",B," + ",P," * ",K," * ","influences["+R.indexOf(G.ID)+"]",r):w(B," = ",P," * ",K," * ","influences["+R.indexOf(G.ID)+"]",r)}}for(var $ in this.connections.gated){var tt=m(this.connections.gated[$],"gain");w(tt," = ",O,n)}}if(!L){var et=m(this,"error","responsibility",this.error.responsibility);if(D){var nt=m("target");w(et," = ",nt," - ",O,o);for(var U in this.connections.inputs){var M=this.connections.inputs[U],K=m(this,"trace","elegibility",M.ID,this.trace.elegibility[M.ID]),S=m(M,"weight");w(S," += ",_," * (",et," * ",K,")",o)}u.push(O.id)}else if(I||T){if(T){w(et," = 0",o);for(var U in this.connections.projected){var $=this.connections.projected[U],G=$.to,it=m($,"weight"),rt=m(G,"error","responsibility",G.error.responsibility);if($.gater){var ot=m($,"gain");w(et," += ",rt," * ",ot," * ",it,o)}else w(et," += ",rt," * ",it,o)}w(et," *= ",P,o);for(var U in this.connections.inputs){var M=this.connections.inputs[U],K=m(this,"trace","elegibility",M.ID,this.trace.elegibility[M.ID]),S=m(M,"weight");w(S," += ",_," * (",et," * ",K,")",o)}}else if(I){w(et," = 0",o);for(var U in this.trace.extended){var G=this.neighboors[U],H=m("aux"),Y=m(G,"old");G.selfconnection.gater==this?w(H," = ",Y,o):w(H," = 0",o);for(var at in this.trace.influences[G.ID]){var $=this.trace.influences[G.ID][at],it=m($,"weight"),st=m($.from,"activation");w(H," += ",it," * ",st,o)}var rt=m(G,"error","responsibility",G.error.responsibility);w(et," += ",rt," * ",H,o)}w(et," *= ",P,o);for(var U in this.connections.inputs){var M=this.connections.inputs[U],ct=m("aux");w(ct," = 0",o);for(var U in this.trace.extended){var G=this.neighboors[U],rt=m(G,"error","responsibility",G.error.responsibility),B=m(this,"trace","extended",G.ID,M.ID,this.trace.extended[G.ID][M.ID]);w(ct," += ",rt," * ",B,o)}var S=m(M,"weight");w(S," += ",_," * ",ct,o)}}}else{var ht=m("aux");for(var U in this.connections.projected){var $=this.connections.projected[U],G=$.to,it=m($,"weight"),rt=m(G,"error","responsibility",G.error.responsibility);if($.gater){var ot=m($,"gain");w(ht," += ",rt," * ",ot," * ",it,o)}else w(ht," += ",rt," * ",it,o)}var ut=m(this,"error","projected",this.error.projected);w(ut," = ",P," * ",ht,o),w(ht," = 0",o);for(var U in this.trace.extended){var G=this.neighboors[U],H=m("aux_2"),Y=m(G,"old");G.selfconnection.gater==this?w(H," = ",Y,o):w(H," = 0",o);for(var at in this.trace.influences[G.ID]){var $=this.trace.influences[G.ID][at],it=m($,"weight"),st=m($.from,"activation");w(H," += ",it," * ",st,o)}var rt=m(G,"error","responsibility",G.error.responsibility);w(ht," += ",rt," * ",H,o)}var pt=m(this,"error","gated",this.error.gated);w(pt," = ",P," * ",ht,o),w(et," = ",ut," + ",pt,o);for(var U in this.connections.inputs){var M=this.connections.inputs[U],ct=m("aux"),K=m(this,"trace","elegibility",M.ID,this.trace.elegibility[M.ID]);w(ct," = ",ut," * ",K,o);for(var U in this.trace.extended){var G=this.neighboors[U],rt=m(G,"error","responsibility",G.error.responsibility),B=m(this,"trace","extended",G.ID,M.ID,this.trace.extended[G.ID][M.ID]);w(ct," += ",rt," * ",B,o)}var S=m(M,"weight");w(S," += ",_," * ",ct,o)}}w(x," += ",_," * ",et,o)}return{memory:a,neurons:s+1,inputs:c,outputs:u,targets:h,variables:p,activation_sentences:f,trace_sentences:l,propagation_sentences:v,layers:d}},t}();n.Neuron=r;var r;!function(t){function e(){return t.neuronQty++}function n(){return{neurons:t.neuronQty,connections:i.connectionQty}}var i=function(){function t(e,n,i){if(this.ID=t.uid(),this.gain=1,this.weight=0,this.gater=null,!e||!n)throw"Connection Error: Invalid neurons";this.from=e,this.to=n,this.weight="undefined"==typeof i||isNaN(i)?.2*Math.random()-.1:i}return t}();t.Connection=i,t.neuronQty=0,t.uid=e,t.quantity=n}(r=n.Neuron||(n.Neuron={}));var r;!function(t){var e;!function(t){function e(){return t.connectionQty++}t.connectionQty=0,t.uid=e}(e=t.Connection||(t.Connection={}))}(r=n.Neuron||(n.Neuron={}))},{"./squash":9}],9:[function(t,e,n){function i(t,e){if(!e)return 1/(1+Math.exp(-t));var n=i(t);return n*(1-n)}function r(t,e){if(e)return 1-Math.pow(r(t),2);var n=Math.exp(t),i=1/n;return(n-i)/(n+i)}function o(t,e){return e?1:t}function a(t,e){return e?1:+(t>0)}n.LOGISTIC=i,n.TANH=r,n.IDENTITY=o,n.HLIM=a},{}],10:[function(t,e,n){var i,r,o=t("./network"),a=t("./layer"),s=t("./neuron"),c=t("./trainer"),h=t("./architect"),u=t("./squash");!function(t){function e(){return i.synaptic=n,t}var n=i&&i.Synaptic;t.ninja=e,t.Neuron=s.Neuron,t.Layer=a.Layer,t.Network=o.Network,t.Trainer=c.Trainer,t.Squash=u,t.Architect=h}(r||(r={})),"undefined"!=typeof i&&(i.synaptic=r),e.exports=r},{"./architect":1,"./layer":6,"./network":7,"./neuron":8,"./squash":9,"./trainer":11}],11:[function(t,e,n){var i=function(){function t(e,n){this.rate=.2,this.iterations=1e5,this.error=.005,n=n||{},this.network=e,this.rate=n.rate||.2,this.iterations=n.iterations||1e5,this.error=n.error||.005,this.cost=n.cost||t.cost.CROSS_ENTROPY}return t.prototype.train=function(t,e){function n(t){for(var e,n,i=t.length;i;e=Math.floor(Math.random()*i),n=t[--i],t[i]=t[e],t[e]=n);return t}var i,r,o,a,s=1,c=0,h=0,u=!1,p=Date.now();for(e&&(e.shuffle,e.iterations&&(this.iterations=e.iterations),e.error&&(this.error=e.error),e.rate&&(this.rate=e.rate),e.cost&&(this.cost=e.cost),e.schedule&&(this.schedule=e.schedule),e.customLog&&(console.log("Deprecated: use schedule instead of customLog"),this.schedule=e.customLog)),a=this.rate,Array.isArray(this.rate)&&(h=Math.floor(this.iterations/this.rate.length));!u&&c<this.iterations&&s>this.error;){if(s=0,h>0){var f=Math.floor(c/h);a=this.rate[f]}for(var l in t)i=t[l].input,o=t[l].output,r=this.network.activate(i),this.network.propagate(a,o),s+=this.cost(o,r);c++,s/=t.length,e&&(this.schedule&&this.schedule.every&&c%this.schedule.every==0?u=this.schedule["do"]({error:s,iterations:c,rate:a}):e.log&&c%e.log==0&&console.log("iterations",c,"error",s,"rate",a),e.shuffle&&n(t))}var v={error:s,iterations:c,time:Date.now()-p};return v},t.prototype.workerTrain=function(t,e,n){
function i(t){for(var e,n,i=t.length;i;e=Math.floor(Math.random()*i),n=t[--i],t[i]=t[e],t[e]=n);return t}function r(t){v.postMessage({action:"activate",input:t,memoryBuffer:s.network.optimized.memory},[s.network.optimized.memory.buffer])}function o(t){if(u>0){var e=Math.floor(h/u);a=this.rate[e]}v.postMessage({action:"propagate",target:t,rate:a,memoryBuffer:s.network.optimized.memory},[s.network.optimized.memory.buffer])}var a,s=this,c=1,h=0,u=0,p=t.length,f=!1,l=Date.now();n&&(n.shuffle,n.iterations&&(this.iterations=n.iterations),n.error&&(this.error=n.error),n.rate&&(this.rate=n.rate),n.cost&&(this.cost=n.cost),n.schedule&&(this.schedule=n.schedule),n.customLog&&console.log("Deprecated: use schedule instead of customLog"),this.schedule=n.customLog),a=this.rate,Array.isArray(this.rate)&&(u=Math.floor(this.iterations/this.rate.length));var v=this.network.worker();v.onmessage=function(a){s.network.optimized.ownership(a.data.memoryBuffer),"propagate"==a.data.action&&(d>=p?(d=0,h++,c/=t.length,n&&(this.schedule&&this.schedule.every&&h%this.schedule.every==0?f=this.schedule["do"]({error:c,iterations:h}):n.log&&h%n.log==0&&console.log("iterations",h,"error",c),n.shuffle&&i(t)),!f&&h<s.iterations&&c>s.error?r(t[d].input):e({error:c,iterations:h,time:Date.now()-l}),c=0):r(t[d].input)),"activate"==a.data.action&&(c+=s.cost(t[d].output,a.data.output),o(t[d].output),d++)};var d=0,h=0;r(t[d].input)},t.prototype.XOR=function(e){if(2!=this.network.inputs()||1!=this.network.outputs())throw"Error: Incompatible network (2 inputs, 1 output)";var n={iterations:1e5,log:!1,shuffle:!0,cost:t.cost.MSE};if(e)for(var i in e)n[i]=e[i];return this.train([{input:[0,0],output:[0]},{input:[1,0],output:[1]},{input:[0,1],output:[1]},{input:[1,1],output:[0]}],n)},t.prototype.DSR=function(t){t=t||{};for(var e=t.targets||[2,4,7,8],n=t.distractors||[3,5,6,9],i=t.prompts||[0,1],r=t.length||24,o=t.success||.95,a=t.iterations||1e5,s=t.rate||.1,c=t.log||0,h=t.schedule||{},u=0,p=0,f=0,l=p=u=E=f=0,v=1,d=e.length+n.length+i.length,g=function(t,e){var n=Math.random()*t|0,i=!1;for(var r in e)n==e[r]&&(i=!0);return i?g(t,e):n},y=function(t,e){for(var n in t)if(Math.round(t[n])!=e[n])return!1;return!0},m=Date.now();a>l&&(o>f||l%1e3!=0);){var w=[],b=r-i.length;for(p=0;b>p;p++){var I=Math.random()*n.length|0;w.push(n[I])}var T=[],L=[];for(p=0;p<i.length;p++)T.push(Math.random()*e.length|0),L.push(g(b,L));for(L=L.sort(),p=0;p<i.length;p++)w[L[p]]=e[T[p]],w.push(i[p]);var D,_=D=0;for(v=0,p=0;r>p;p++){var O=[];for(E=0;d>E;E++)O[E]=0;O[w[p]]=1;var z=[];for(E=0;E<e.length;E++)z[E]=0;if(p>=b){var N=p-b;z[T[N]]=1}var x=this.network.activate(O);y(x,z)?b>p?D++:_++:this.network.propagate(s,z);var j=0;for(var E in x)j+=Math.pow(z[E]-x[E],2);v+=j/this.network.outputs(),D+_==r&&u++}l%1e3==0&&(u=0),l++;var k=l%1e3;k=0==k?1e3:k,f=u/k,v/=r,c&&l%c==0&&console.log("iterations:",l," success:",f," correct:",u," time:",Date.now()-m," error:",v),h["do"]&&h.every&&l%h.every==0&&h["do"]({iterations:l,success:f,error:v,time:Date.now()-m,correct:u})}return{iterations:l,success:f,error:v,time:Date.now()-m}},t.prototype.ERG=function(t){t=t||{};var e=t.iterations||15e4,n=t.error||.05,i=t.rate||.1,r=t.log||500,o=function(){this.paths=[]};o.prototype={connect:function(t,e){return this.paths.push({node:t,value:e}),this},any:function(){if(0==this.paths.length)return!1;var t=Math.random()*this.paths.length|0;return this.paths[t]},test:function(t){for(var e in this.paths)if(this.paths[e].value==t)return this.paths[e];return!1}};for(var a=function(){var t=new o,e=(new o).connect(t,"E"),n=(new o).connect(e,"S"),i=(new o).connect(e,"V").connect(n,"P"),r=(new o).connect(n,"X");r.connect(r,"S");var a=(new o).connect(i,"V");a.connect(a,"T"),n.connect(a,"X");var s=(new o).connect(r,"T").connect(a,"P"),c=(new o).connect(s,"B");return{input:c,output:t}},s=function(){var t=a(),e=a(),n=new o,i=(new o).connect(n,"E");t.output.connect(i,"T"),e.output.connect(i,"P");var r=(new o).connect(t.input,"P").connect(e.input,"T"),s=(new o).connect(r,"B");return{input:s,output:n}},c=function(){for(var t=s().input,e=t.any(),n="";e;)n+=e.value,e=e.node.any();return n},h=function(t){for(var e=s().input,n=0,i=t.charAt(n);n<t.length;){var r=e.test(i);if(!r)return!1;e=r.node,i=t.charAt(++n)}return!0},u=function(t,e){var n=0,i=-1,r=0,o=-1;for(var a in t)t[a]>n&&(n=t[a],i=a),e[a]>r&&(r=e[a],o=a);return i!=o},p=0,f=1,l={B:0,P:1,T:2,X:3,S:4,E:5},v=Date.now();e>p&&f>n;){var d=0;f=0;for(var g=c(),y=g.charAt(d),m=g.charAt(d+1);d<g.length-1;){for(var w=[],b=[],I=0;6>I;I++)w[I]=0,b[I]=0;w[l[y]]=1,b[l[m]]=1;var T=this.network.activate(w);u(T,b)&&this.network.propagate(i,b),y=g.charAt(++d),m=g.charAt(d+1);var L=0;for(var D in T)L+=Math.pow(b[D]-T[D],2);L/=T.length,f+=L}f/=g.length,p++,p%r==0&&console.log("iterations:",p," time:",Date.now()-v," error:",f)}return{iterations:p,error:f,time:Date.now()-v,test:h,generate:c}},t}();n.Trainer=i;var i;!function(t){t.cost={CROSS_ENTROPY:function(t,e){var n=0;for(var i in e)n-=t[i]*Math.log(e[i]+1e-15)+(1-t[i])*Math.log(1+1e-15-e[i]);return n},MSE:function(t,e){var n=0;for(var i in e)n+=Math.pow(t[i]-e[i],2);return n/e.length}}}(i=n.Trainer||(n.Trainer={}))},{}]},{},[10]);var synaptic = synaptic || Synaptic;var Neuron = synaptic.Neuron, Layer = synaptic.Layer, Network = synaptic.Network, Trainer = synaptic.Trainer, Architect = synaptic.Architect;